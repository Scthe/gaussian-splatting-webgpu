(()=>{var F=1e-6;var Fe=Float32Array;function X(n,e,t){let r=new Fe(3);return n!==void 0&&(r[0]=n,e!==void 0&&(r[1]=e,t!==void 0&&(r[2]=t))),r}var _t=new Map([[Float32Array,()=>new Float32Array(12)],[Float64Array,()=>new Float64Array(12)],[Array,()=>new Array(12).fill(0)]]),Yr=_t.get(Float32Array);function nn(n,e,t){return t=t||new Fe(3),t[0]=n[0]-e[0],t[1]=n[1]-e[1],t[2]=n[2]-e[2],t}function ue(n,e,t){t=t||new Fe(3);let r=n[2]*e[0]-n[0]*e[2],o=n[0]*e[1]-n[1]*e[0];return t[0]=n[1]*e[2]-n[2]*e[1],t[1]=r,t[2]=o,t}function J(n,e){e=e||new Fe(3);let t=n[0],r=n[1],o=n[2],i=Math.sqrt(t*t+r*r+o*o);return i>1e-5?(e[0]=t/i,e[1]=r/i,e[2]=o/i):(e[0]=0,e[1]=0,e[2]=0),e}var x=Float32Array;function gt(n){let e=x;return x=n,e}function dt(n,e,t,r,o,i,a,s,c,f,h,l,p,d,v,g){let _=new x(16);return n!==void 0&&(_[0]=n,e!==void 0&&(_[1]=e,t!==void 0&&(_[2]=t,r!==void 0&&(_[3]=r,o!==void 0&&(_[4]=o,i!==void 0&&(_[5]=i,a!==void 0&&(_[6]=a,s!==void 0&&(_[7]=s,c!==void 0&&(_[8]=c,f!==void 0&&(_[9]=f,h!==void 0&&(_[10]=h,l!==void 0&&(_[11]=l,p!==void 0&&(_[12]=p,d!==void 0&&(_[13]=d,v!==void 0&&(_[14]=v,g!==void 0&&(_[15]=g)))))))))))))))),_}function vt(n,e,t,r,o,i,a,s,c,f,h,l,p,d,v,g,_){return _=_||new x(16),_[0]=n,_[1]=e,_[2]=t,_[3]=r,_[4]=o,_[5]=i,_[6]=a,_[7]=s,_[8]=c,_[9]=f,_[10]=h,_[11]=l,_[12]=p,_[13]=d,_[14]=v,_[15]=g,_}function yt(n,e){return e=e||new x(16),e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=0,e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=0,e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function bt(n,e){e=e||new x(16);let t=n[0],r=n[1],o=n[2],i=n[3],a=t+t,s=r+r,c=o+o,f=t*a,h=r*a,l=r*s,p=o*a,d=o*s,v=o*c,g=i*a,_=i*s,y=i*c;return e[0]=1-l-v,e[1]=h+y,e[2]=p-_,e[3]=0,e[4]=h-y,e[5]=1-f-v,e[6]=d+g,e[7]=0,e[8]=p+_,e[9]=d-g,e[10]=1-f-l,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function wt(n,e){return e=e||new x(16),e[0]=-n[0],e[1]=-n[1],e[2]=-n[2],e[3]=-n[3],e[4]=-n[4],e[5]=-n[5],e[6]=-n[6],e[7]=-n[7],e[8]=-n[8],e[9]=-n[9],e[10]=-n[10],e[11]=-n[11],e[12]=-n[12],e[13]=-n[13],e[14]=-n[14],e[15]=-n[15],e}function tn(n,e){return e=e||new x(16),e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e}var xt=tn;function St(n,e){return Math.abs(n[0]-e[0])<F&&Math.abs(n[1]-e[1])<F&&Math.abs(n[2]-e[2])<F&&Math.abs(n[3]-e[3])<F&&Math.abs(n[4]-e[4])<F&&Math.abs(n[5]-e[5])<F&&Math.abs(n[6]-e[6])<F&&Math.abs(n[7]-e[7])<F&&Math.abs(n[8]-e[8])<F&&Math.abs(n[9]-e[9])<F&&Math.abs(n[10]-e[10])<F&&Math.abs(n[11]-e[11])<F&&Math.abs(n[12]-e[12])<F&&Math.abs(n[13]-e[13])<F&&Math.abs(n[14]-e[14])<F&&Math.abs(n[15]-e[15])<F}function Et(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]&&n[12]===e[12]&&n[13]===e[13]&&n[14]===e[14]&&n[15]===e[15]}function Sn(n){return n=n||new x(16),n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function Pt(n,e){if(e=e||new x(16),e===n){let b;return b=n[1],n[1]=n[4],n[4]=b,b=n[2],n[2]=n[8],n[8]=b,b=n[3],n[3]=n[12],n[12]=b,b=n[6],n[6]=n[9],n[9]=b,b=n[7],n[7]=n[13],n[13]=b,b=n[11],n[11]=n[14],n[14]=b,e}let t=n[0*4+0],r=n[0*4+1],o=n[0*4+2],i=n[0*4+3],a=n[1*4+0],s=n[1*4+1],c=n[1*4+2],f=n[1*4+3],h=n[2*4+0],l=n[2*4+1],p=n[2*4+2],d=n[2*4+3],v=n[3*4+0],g=n[3*4+1],_=n[3*4+2],y=n[3*4+3];return e[0]=t,e[1]=a,e[2]=h,e[3]=v,e[4]=r,e[5]=s,e[6]=l,e[7]=g,e[8]=o,e[9]=c,e[10]=p,e[11]=_,e[12]=i,e[13]=f,e[14]=d,e[15]=y,e}function En(n,e){e=e||new x(16);let t=n[0*4+0],r=n[0*4+1],o=n[0*4+2],i=n[0*4+3],a=n[1*4+0],s=n[1*4+1],c=n[1*4+2],f=n[1*4+3],h=n[2*4+0],l=n[2*4+1],p=n[2*4+2],d=n[2*4+3],v=n[3*4+0],g=n[3*4+1],_=n[3*4+2],y=n[3*4+3],b=p*y,w=_*d,S=c*y,M=_*f,T=c*d,U=p*f,O=o*y,G=_*i,I=o*d,D=p*i,$=o*f,z=c*i,L=h*g,N=v*l,q=a*g,H=v*s,V=a*l,Ue=h*s,Oe=t*g,Ge=v*r,Ie=t*l,De=h*r,$e=t*s,ke=a*r,yn=b*s+M*l+T*g-(w*s+S*l+U*g),bn=w*r+O*l+D*g-(b*r+G*l+I*g),wn=S*r+G*s+$*g-(M*r+O*s+z*g),xn=U*r+I*s+z*l-(T*r+D*s+$*l),k=1/(t*yn+a*bn+h*wn+v*xn);return e[0]=k*yn,e[1]=k*bn,e[2]=k*wn,e[3]=k*xn,e[4]=k*(w*a+S*h+U*v-(b*a+M*h+T*v)),e[5]=k*(b*t+G*h+I*v-(w*t+O*h+D*v)),e[6]=k*(M*t+O*a+z*v-(S*t+G*a+$*v)),e[7]=k*(T*t+D*a+$*h-(U*t+I*a+z*h)),e[8]=k*(L*f+H*d+V*y-(N*f+q*d+Ue*y)),e[9]=k*(N*i+Oe*d+De*y-(L*i+Ge*d+Ie*y)),e[10]=k*(q*i+Ge*f+$e*y-(H*i+Oe*f+ke*y)),e[11]=k*(Ue*i+Ie*f+ke*d-(V*i+De*f+$e*d)),e[12]=k*(q*p+Ue*_+N*c-(V*_+L*c+H*p)),e[13]=k*(Ie*_+L*o+Ge*p-(Oe*p+De*_+N*o)),e[14]=k*(Oe*c+ke*_+H*o-($e*_+q*o+Ge*c)),e[15]=k*($e*p+V*o+De*c-(Ie*c+ke*p+Ue*o)),e}function Ct(n){let e=n[0],t=n[0*4+1],r=n[0*4+2],o=n[0*4+3],i=n[1*4+0],a=n[1*4+1],s=n[1*4+2],c=n[1*4+3],f=n[2*4+0],h=n[2*4+1],l=n[2*4+2],p=n[2*4+3],d=n[3*4+0],v=n[3*4+1],g=n[3*4+2],_=n[3*4+3],y=l*_,b=g*p,w=s*_,S=g*c,M=s*p,T=l*c,U=r*_,O=g*o,G=r*p,I=l*o,D=r*c,$=s*o,z=y*a+S*h+M*v-(b*a+w*h+T*v),L=b*t+U*h+I*v-(y*t+O*h+G*v),N=w*t+O*a+D*v-(S*t+U*a+$*v),q=T*t+G*a+$*h-(M*t+I*a+D*h);return e*z+i*L+f*N+d*q}var At=En;function Pn(n,e,t){t=t||new x(16);let r=n[0],o=n[1],i=n[2],a=n[3],s=n[4],c=n[5],f=n[6],h=n[7],l=n[8],p=n[9],d=n[10],v=n[11],g=n[12],_=n[13],y=n[14],b=n[15],w=e[0],S=e[1],M=e[2],T=e[3],U=e[4],O=e[5],G=e[6],I=e[7],D=e[8],$=e[9],z=e[10],L=e[11],N=e[12],q=e[13],H=e[14],V=e[15];return t[0]=r*w+s*S+l*M+g*T,t[1]=o*w+c*S+p*M+_*T,t[2]=i*w+f*S+d*M+y*T,t[3]=a*w+h*S+v*M+b*T,t[4]=r*U+s*O+l*G+g*I,t[5]=o*U+c*O+p*G+_*I,t[6]=i*U+f*O+d*G+y*I,t[7]=a*U+h*O+v*G+b*I,t[8]=r*D+s*$+l*z+g*L,t[9]=o*D+c*$+p*z+_*L,t[10]=i*D+f*$+d*z+y*L,t[11]=a*D+h*$+v*z+b*L,t[12]=r*N+s*q+l*H+g*V,t[13]=o*N+c*q+p*H+_*V,t[14]=i*N+f*q+d*H+y*V,t[15]=a*N+h*q+v*H+b*V,t}var Mt=Pn;function Bt(n,e,t){return t=t||Sn(),n!==t&&(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11]),t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function Rt(n,e){return e=e||X(),e[0]=n[12],e[1]=n[13],e[2]=n[14],e}function Tt(n,e,t){t=t||X();let r=e*4;return t[0]=n[r+0],t[1]=n[r+1],t[2]=n[r+2],t}function Ut(n,e,t,r){r!==n&&(r=tn(n,r));let o=t*4;return r[o+0]=e[0],r[o+1]=e[1],r[o+2]=e[2],r}function Ot(n,e){e=e||X();let t=n[0],r=n[1],o=n[2],i=n[4],a=n[5],s=n[6],c=n[8],f=n[9],h=n[10];return e[0]=Math.sqrt(t*t+r*r+o*o),e[1]=Math.sqrt(i*i+a*a+s*s),e[2]=Math.sqrt(c*c+f*f+h*h),e}function Gt(n,e,t,r,o){o=o||new x(16);let i=Math.tan(Math.PI*.5-.5*n);if(o[0]=i/e,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,Number.isFinite(r)){let a=1/(t-r);o[10]=r*a,o[14]=r*t*a}else o[10]=-1,o[14]=-t;return o}function It(n,e,t,r=1/0,o){o=o||new x(16);let i=1/Math.tan(n*.5);if(o[0]=i/e,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,r===1/0)o[10]=0,o[14]=t;else{let a=1/(r-t);o[10]=t*a,o[14]=r*t*a}return o}function Dt(n,e,t,r,o,i,a){return a=a||new x(16),a[0]=2/(e-n),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(r-t),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1/(o-i),a[11]=0,a[12]=(e+n)/(n-e),a[13]=(r+t)/(t-r),a[14]=o/(o-i),a[15]=1,a}function $t(n,e,t,r,o,i,a){a=a||new x(16);let s=e-n,c=r-t,f=o-i;return a[0]=2*o/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*o/c,a[6]=0,a[7]=0,a[8]=(n+e)/s,a[9]=(r+t)/c,a[10]=i/f,a[11]=-1,a[12]=0,a[13]=0,a[14]=o*i/f,a[15]=0,a}function kt(n,e,t,r,o,i=1/0,a){a=a||new x(16);let s=e-n,c=r-t;if(a[0]=2*o/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*o/c,a[6]=0,a[7]=0,a[8]=(n+e)/s,a[9]=(r+t)/c,a[11]=-1,a[12]=0,a[13]=0,a[15]=0,i===1/0)a[10]=0,a[14]=o;else{let f=1/(i-o);a[10]=o*f,a[14]=i*o*f}return a}var P,B,E;function Ft(n,e,t,r){return r=r||new x(16),P=P||X(),B=B||X(),E=E||X(),J(nn(e,n,E),E),J(ue(t,E,P),P),J(ue(E,P,B),B),r[0]=P[0],r[1]=P[1],r[2]=P[2],r[3]=0,r[4]=B[0],r[5]=B[1],r[6]=B[2],r[7]=0,r[8]=E[0],r[9]=E[1],r[10]=E[2],r[11]=0,r[12]=n[0],r[13]=n[1],r[14]=n[2],r[15]=1,r}function zt(n,e,t,r){return r=r||new x(16),P=P||X(),B=B||X(),E=E||X(),J(nn(n,e,E),E),J(ue(t,E,P),P),J(ue(E,P,B),B),r[0]=P[0],r[1]=P[1],r[2]=P[2],r[3]=0,r[4]=B[0],r[5]=B[1],r[6]=B[2],r[7]=0,r[8]=E[0],r[9]=E[1],r[10]=E[2],r[11]=0,r[12]=n[0],r[13]=n[1],r[14]=n[2],r[15]=1,r}function Lt(n,e,t,r){return r=r||new x(16),P=P||X(),B=B||X(),E=E||X(),J(nn(n,e,E),E),J(ue(t,E,P),P),J(ue(E,P,B),B),r[0]=P[0],r[1]=B[0],r[2]=E[0],r[3]=0,r[4]=P[1],r[5]=B[1],r[6]=E[1],r[7]=0,r[8]=P[2],r[9]=B[2],r[10]=E[2],r[11]=0,r[12]=-(P[0]*n[0]+P[1]*n[1]+P[2]*n[2]),r[13]=-(B[0]*n[0]+B[1]*n[1]+B[2]*n[2]),r[14]=-(E[0]*n[0]+E[1]*n[1]+E[2]*n[2]),r[15]=1,r}function Nt(n,e){return e=e||new x(16),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function qt(n,e,t){t=t||new x(16);let r=e[0],o=e[1],i=e[2],a=n[0],s=n[1],c=n[2],f=n[3],h=n[1*4+0],l=n[1*4+1],p=n[1*4+2],d=n[1*4+3],v=n[2*4+0],g=n[2*4+1],_=n[2*4+2],y=n[2*4+3],b=n[3*4+0],w=n[3*4+1],S=n[3*4+2],M=n[3*4+3];return n!==t&&(t[0]=a,t[1]=s,t[2]=c,t[3]=f,t[4]=h,t[5]=l,t[6]=p,t[7]=d,t[8]=v,t[9]=g,t[10]=_,t[11]=y),t[12]=a*r+h*o+v*i+b,t[13]=s*r+l*o+g*i+w,t[14]=c*r+p*o+_*i+S,t[15]=f*r+d*o+y*i+M,t}function Ht(n,e){e=e||new x(16);let t=Math.cos(n),r=Math.sin(n);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Vt(n,e,t){t=t||new x(16);let r=n[4],o=n[5],i=n[6],a=n[7],s=n[8],c=n[9],f=n[10],h=n[11],l=Math.cos(e),p=Math.sin(e);return t[4]=l*r+p*s,t[5]=l*o+p*c,t[6]=l*i+p*f,t[7]=l*a+p*h,t[8]=l*s-p*r,t[9]=l*c-p*o,t[10]=l*f-p*i,t[11]=l*h-p*a,n!==t&&(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t}function jt(n,e){e=e||new x(16);let t=Math.cos(n),r=Math.sin(n);return e[0]=t,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Yt(n,e,t){t=t||new x(16);let r=n[0*4+0],o=n[0*4+1],i=n[0*4+2],a=n[0*4+3],s=n[2*4+0],c=n[2*4+1],f=n[2*4+2],h=n[2*4+3],l=Math.cos(e),p=Math.sin(e);return t[0]=l*r-p*s,t[1]=l*o-p*c,t[2]=l*i-p*f,t[3]=l*a-p*h,t[8]=l*s+p*r,t[9]=l*c+p*o,t[10]=l*f+p*i,t[11]=l*h+p*a,n!==t&&(t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t}function Xt(n,e){e=e||new x(16);let t=Math.cos(n),r=Math.sin(n);return e[0]=t,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Wt(n,e,t){t=t||new x(16);let r=n[0*4+0],o=n[0*4+1],i=n[0*4+2],a=n[0*4+3],s=n[1*4+0],c=n[1*4+1],f=n[1*4+2],h=n[1*4+3],l=Math.cos(e),p=Math.sin(e);return t[0]=l*r+p*s,t[1]=l*o+p*c,t[2]=l*i+p*f,t[3]=l*a+p*h,t[4]=l*s-p*r,t[5]=l*c-p*o,t[6]=l*f-p*i,t[7]=l*h-p*a,n!==t&&(t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t}function Cn(n,e,t){t=t||new x(16);let r=n[0],o=n[1],i=n[2],a=Math.sqrt(r*r+o*o+i*i);r/=a,o/=a,i/=a;let s=r*r,c=o*o,f=i*i,h=Math.cos(e),l=Math.sin(e),p=1-h;return t[0]=s+(1-s)*h,t[1]=r*o*p+i*l,t[2]=r*i*p-o*l,t[3]=0,t[4]=r*o*p-i*l,t[5]=c+(1-c)*h,t[6]=o*i*p+r*l,t[7]=0,t[8]=r*i*p+o*l,t[9]=o*i*p-r*l,t[10]=f+(1-f)*h,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}var Kt=Cn;function An(n,e,t,r){r=r||new x(16);let o=e[0],i=e[1],a=e[2],s=Math.sqrt(o*o+i*i+a*a);o/=s,i/=s,a/=s;let c=o*o,f=i*i,h=a*a,l=Math.cos(t),p=Math.sin(t),d=1-l,v=c+(1-c)*l,g=o*i*d+a*p,_=o*a*d-i*p,y=o*i*d-a*p,b=f+(1-f)*l,w=i*a*d+o*p,S=o*a*d+i*p,M=i*a*d-o*p,T=h+(1-h)*l,U=n[0],O=n[1],G=n[2],I=n[3],D=n[4],$=n[5],z=n[6],L=n[7],N=n[8],q=n[9],H=n[10],V=n[11];return r[0]=v*U+g*D+_*N,r[1]=v*O+g*$+_*q,r[2]=v*G+g*z+_*H,r[3]=v*I+g*L+_*V,r[4]=y*U+b*D+w*N,r[5]=y*O+b*$+w*q,r[6]=y*G+b*z+w*H,r[7]=y*I+b*L+w*V,r[8]=S*U+M*D+T*N,r[9]=S*O+M*$+T*q,r[10]=S*G+M*z+T*H,r[11]=S*I+M*L+T*V,n!==r&&(r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15]),r}var Qt=An;function Zt(n,e){return e=e||new x(16),e[0]=n[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=n[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Jt(n,e,t){t=t||new x(16);let r=e[0],o=e[1],i=e[2];return t[0]=r*n[0*4+0],t[1]=r*n[0*4+1],t[2]=r*n[0*4+2],t[3]=r*n[0*4+3],t[4]=o*n[1*4+0],t[5]=o*n[1*4+1],t[6]=o*n[1*4+2],t[7]=o*n[1*4+3],t[8]=i*n[2*4+0],t[9]=i*n[2*4+1],t[10]=i*n[2*4+2],t[11]=i*n[2*4+3],n!==t&&(t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t}function er(n,e){return e=e||new x(16),e[0]=n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function nr(n,e,t){return t=t||new x(16),t[0]=e*n[0*4+0],t[1]=e*n[0*4+1],t[2]=e*n[0*4+2],t[3]=e*n[0*4+3],t[4]=e*n[1*4+0],t[5]=e*n[1*4+1],t[6]=e*n[1*4+2],t[7]=e*n[1*4+3],t[8]=e*n[2*4+0],t[9]=e*n[2*4+1],t[10]=e*n[2*4+2],t[11]=e*n[2*4+3],n!==t&&(t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t}var j={__proto__:null,aim:Ft,axisRotate:An,axisRotation:Cn,cameraAim:zt,clone:xt,copy:tn,create:dt,determinant:Ct,equals:Et,equalsApproximately:St,fromMat3:yt,fromQuat:bt,frustum:$t,frustumReverseZ:kt,getAxis:Tt,getScaling:Ot,getTranslation:Rt,identity:Sn,inverse:En,invert:At,lookAt:Lt,mul:Mt,multiply:Pn,negate:wt,ortho:Dt,perspective:Gt,perspectiveReverseZ:It,rotate:Qt,rotateX:Vt,rotateY:Yt,rotateZ:Wt,rotation:Kt,rotationX:Ht,rotationY:jt,rotationZ:Xt,scale:Jt,scaling:Zt,set:vt,setAxis:Ut,setDefaultType:gt,setTranslation:Bt,translate:qt,translation:Nt,transpose:Pt,uniformScale:nr,uniformScaling:er};var ne={position:[2.5,0,2.5],target:[-1.5,3,0],fovDgr:60,near:.01,far:100},Se=1,W=4,ze=4,Mn=8,ae=W*4,ee=W*16,C={githubRepoLink:"https://github.com/Scthe/gaussian-splatting-webgpu",sortMethod:"GPU",renderMethod:"Eigenvectors",scaleModifier:1,clearColor:[0,0,0],rotationSpeed:1,movementSpeed:2,drawGround:!1};async function Bn(){try{let n=await navigator.gpu.requestAdapter({powerPreference:"high-performance"}),e=i=>console.error(`WebGPU init error: '${i}'`);if(!n){e("No adapter found. WebGPU seems to be unavailable.");return}let t=n.features.has("timestamp-query"),r=[];t&&r.push("timestamp-query");let o=await n?.requestDevice({requiredFeatures:r});if(!o){e("Failed to get GPUDevice from the adapter.");return}return o}catch(n){console.error(n);return}}var tr=n=>n*Math.PI/180;function rn(n){let e=n.width/n.height;return j.perspective(tr(ne.fovDgr),e,ne.near,ne.far)}function Rn(n,e){return j.multiply(e,n)}var le=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST;function se(n,e,t,r){let o=n.createBuffer({label:e,size:r.byteLength,usage:t});return n.queue.writeBuffer(o,0,r),o}function fe(n,e,t,r){let o=r;n.queue.writeBuffer(e,t,o.buffer,0)}function Tn(n,e,t,r){let o=(n&255)<<24,i=(e&255)<<16,a=(t&255)<<8,s=(r&255)<<0;return o+i+a+s}function rr(n){return 1<<31-Math.clz32(n)}function Un(n){let e=rr(n);return e===n?n:2*e}var On=n=>Array(n).fill(0);function Le(n,e,t){return n[2]*e[t]+n[6]*e[t+1]+n[10]*e[t+2]}function te(n){if(!n.SHADER_CODE||n.SHADER_CODE.length==0)throw new Error(`${n.name} has no .SHADER_CODE defined.`)}function pe(n,e){let t=n;return e=e||{},Object.entries(e).forEach(([r,o])=>{t=t.replaceAll(r,o)}),t}var he=(n,e)=>Math.ceil(n/e),Gn=(n,e,t)=>(t=Math.max(0,Math.min(1,t)),n*(1-t)+e*t);function In(n){let e=["internal","out-of-memory","validation"],t=e.toReversed(),r="-";return{startErrorScope:o,reportErrorScopeAsync:i};function o(a="-"){r=a,e.forEach(s=>n.pushErrorScope(s))}async function i(a){let s;for(let c of t){let f=await n.popErrorScope();if(f){let h=`WebGPU error [${r}][${c}]: ${f.message}`;s=h,a?a(h):console.error(h)}}return s}}var me={CAMERA_FORWARD:"w",CAMERA_BACK:"s",CAMERA_LEFT:"a",CAMERA_RIGHT:"d",CAMERA_UP:" ",CAMERA_DOWN:"z"};function Dn(n,e){let t={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1},r={x:0,y:0,zoom:0,touching:!1},o=(i,a)=>{switch(i.key){case me.CAMERA_FORWARD:t.forward=a,i.preventDefault(),i.stopPropagation();break;case me.CAMERA_BACK:t.backward=a,i.preventDefault(),i.stopPropagation();break;case me.CAMERA_LEFT:t.left=a,i.preventDefault(),i.stopPropagation();break;case me.CAMERA_RIGHT:t.right=a,i.preventDefault(),i.stopPropagation();break;case me.CAMERA_UP:t.up=a,i.preventDefault(),i.stopPropagation();break;case me.CAMERA_DOWN:t.down=a,i.preventDefault(),i.stopPropagation();break}};return n.addEventListener("keydown",i=>o(i,!0)),n.addEventListener("keyup",i=>o(i,!1)),e.style.touchAction="pinch-zoom",e.addEventListener("pointerdown",()=>{r.touching=!0}),e.addEventListener("pointerup",()=>{r.touching=!1}),e.addEventListener("pointermove",i=>{r.touching=i.pointerType=="mouse"?(i.buttons&1)!==0:!0,r.touching&&(r.x+=i.movementX,r.y+=i.movementY)}),e.addEventListener("wheel",i=>{r.touching=(i.buttons&1)!==0,r.touching&&(r.zoom+=Math.sign(i.deltaY),i.preventDefault(),i.stopPropagation())},{passive:!1}),()=>{let i={directions:{...t},mouse:{...r}};return r.x=0,r.y=0,r.zoom=0,i}}var _e=class n{static BUFFER_SIZE=ee+ee+ee+ae+ae;gpuBuffer;constructor(e){this.gpuBuffer=e.createBuffer({label:"GlobalUniformBuffer",size:n.BUFFER_SIZE,usage:le})}createBindingDesc(e){return{binding:e,resource:{buffer:this.gpuBuffer}}}update(e){let{device:t,mvpMatrix:r,viewMatrix:o,projMatrix:i,viewport:a,focalX:s,focalY:c}=e,f=0;fe(t,this.gpuBuffer,f,r),f+=ee,fe(t,this.gpuBuffer,f,o),f+=ee,fe(t,this.gpuBuffer,f,i),f+=ee;let h=new Float32Array([a.width,a.height,s,c]);t.queue.writeBuffer(this.gpuBuffer,f,h.buffer,0),f+=ae,h[0]=C.scaleModifier,t.queue.writeBuffer(this.gpuBuffer,f,h.buffer,0),f+=ae}};var on=3*W+3*W+4*Se+4*Se,Y=6;var or=[],ir={entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{minBindingSize:_e.BUFFER_SIZE}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]},Ee=class n{static SHADER_CODE="";static NAME=n.name;uniformsLayout;renderPipelineEigenvectors;renderPipelineSquare;uniformsBindings;constructor(e,t,r,o){te(n),this.uniformsLayout=e.createBindGroupLayout(ir);let i=e.createShaderModule({code:n.SHADER_CODE}),a=e.createPipelineLayout({bindGroupLayouts:[this.uniformsLayout]});this.renderPipelineEigenvectors=n.createRenderPipeline(e,a,i,t,"vs_mainEigenvectors","fs_mainEigenvectors"),this.renderPipelineSquare=n.createRenderPipeline(e,a,i,t,"vs_mainSquare","fs_mainSquare"),this.uniformsBindings=n.assignResourcesToBindings(e,this.uniformsLayout,r,o)}static createRenderPipeline(e,t,r,o,i,a){return e.createRenderPipeline({label:`splats-render-${i}`,layout:t,vertex:{module:r,entryPoint:i,buffers:or},fragment:{module:r,entryPoint:a,targets:[{format:o,blend:{color:{srcFactor:"one-minus-dst-alpha",dstFactor:"one",operation:"add"},alpha:{srcFactor:"one-minus-dst-alpha",dstFactor:"one",operation:"add"}}}]},primitive:{cullMode:"none",topology:"triangle-list",stripIndexFormat:void 0}})}static assignResourcesToBindings(e,t,r,o){return e.createBindGroup({layout:t,entries:[r.createBindingDesc(0),{binding:1,resource:{buffer:o.positionsBuffer}},{binding:2,resource:{buffer:o.rotationsBuffer}},{binding:3,resource:{buffer:o.scalesBuffer}},{binding:4,resource:{buffer:o.colorsBuffer}}]})}draw(e,t,r){let{cmdBuf:o,splats:i,profiler:a}=e,s=o.beginRenderPass({label:n.NAME,colorAttachments:[{view:t.createView(),loadOp:r,storeOp:"store",clearValue:[C.clearColor[0],C.clearColor[1],C.clearColor[2],0]}],timestampWrites:a?.createScopeGpu(n.NAME)}),c=C.renderMethod==="SQUARE_BILLBOARD"?this.renderPipelineSquare:this.renderPipelineEigenvectors;s.setPipeline(c),s.setBindGroup(0,this.uniformsBindings),s.setIndexBuffer(i.indicesBuffer,"uint32");let f=i.count*Y;s.drawIndexed(f,1,0,0,0),s.end()}};var ge=class n{static NAME=n.name;static SHADER_CODE="";static NUM_THREADS=8192;static WORKGROUP_SIZE=128;pipeline;gpuUniformBuffers;gpuUniformBuffersBindGroups;constructor(e,t,r,o){te(n);let i=he(t,n.NUM_THREADS);this.pipeline=n.createPipeline(e,i),this.gpuUniformBuffers=n.createUniformBuffers(e,t),console.log(`Bitonic sort will have ${this.gpuUniformBuffers.length} passes.`),this.gpuUniformBuffersBindGroups=this.gpuUniformBuffers.map(a=>n.createBindGroup(e,this.pipeline,r,o,a))}static createPipeline(e,t){let r=pe(n.SHADER_CODE,{__ITEMS_PER_THREAD__:""+t,__WORKGROUP_SIZE__:""+n.WORKGROUP_SIZE}),o=e.createShaderModule({code:r});return e.createComputePipeline({layout:"auto",compute:{module:o,entryPoint:"main"}})}cmdSort(e){let{cmdBuf:t,profiler:r}=e;this.gpuUniformBuffersBindGroups.forEach(o=>{let i=t.beginComputePass({timestampWrites:r?.createScopeGpu(n.NAME)});i.setPipeline(this.pipeline),i.setBindGroup(0,o),i.dispatchWorkgroups(n.NUM_THREADS/n.WORKGROUP_SIZE),i.end()})}static createUniformBuffers(e,t){let r=[];for(let o=2;o<=t;o<<=1)for(let i=o>>1;i>0;i>>=1){let a=new Uint32Array([i,o]),s=se(e,`bitonic-sort.uniforms-buffer(k=${o},j=${i})`,le,a);r.push(s)}return r}static createBindGroup=(e,t,r,o,i)=>e.createBindGroup({layout:t.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:r}},{binding:1,resource:{buffer:o}},{binding:2,resource:{buffer:i}}]})};var de=class n{static NAME=n.name;static NUM_THREADS=64;static SHADER_CODE="";pipeline;uniformsBindings;uniformsBuffer;constructor(e,t,r,o){te(n);let i=t.size/ae,a=he(i,n.NUM_THREADS);this.uniformsBuffer=e.createBuffer({label:"CalcDepthsPass-uniforms",size:ee,usage:le}),this.pipeline=n.createPipeline(e,i,a),this.uniformsBindings=e.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:t}},{binding:1,resource:{buffer:r}},{binding:2,resource:{buffer:o}},{binding:3,resource:{buffer:this.uniformsBuffer}}]})}static createPipeline(e,t,r){let o=pe(n.SHADER_CODE,{__ITEMS_PER_THREAD__:""+r,__SPLAT_COUNT__:""+t}),i=e.createShaderModule({code:o});return e.createComputePipeline({layout:"auto",compute:{module:i,entryPoint:"main"}})}cmdCalcDepths(e){let{cmdBuf:t,device:r,mvpMatrix:o,profiler:i}=e;fe(r,this.uniformsBuffer,0,o);let a=t.beginComputePass({label:"calc-depths-pass",timestampWrites:i?.createScopeGpu(n.NAME)});a.setPipeline(this.pipeline),a.setBindGroup(0,this.uniformsBindings),a.dispatchWorkgroups(n.NUM_THREADS),a.end()}};var ve=class n{static NAME=n.name;static NUM_THREADS=64;static SHADER_CODE="";pipeline;uniformsBindings;constructor(e,t,r,o){te(n);let i=he(o,n.NUM_THREADS);this.pipeline=n.createPipeline(e,i),this.uniformsBindings=e.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:t}},{binding:1,resource:{buffer:r}}]})}static createPipeline(e,t){let r=pe(n.SHADER_CODE,{__ITEMS_PER_THREAD__:""+t,__VERTICES_PER_SPLAT__:""+Y}),o=e.createShaderModule({code:r});return e.createComputePipeline({layout:"auto",compute:{module:o,entryPoint:"main"}})}cmdUnrollIndices(e){let{cmdBuf:t,profiler:r}=e,o=t.beginComputePass({label:"unroll-indices-pass",timestampWrites:r?.createScopeGpu(n.NAME)});o.setPipeline(this.pipeline),o.setBindGroup(0,this.uniformsBindings),o.dispatchWorkgroups(n.NUM_THREADS),o.end()}};var Ne=class n{itemCountCeilPwr2;indicesBuffer;distancesBuffer;calcDepthsPass;bitonicSort;unrollIndicesPass;constructor(e,t){this.itemCountCeilPwr2=Un(t.count);let[r,o]=n.createBuffers(e,this.itemCountCeilPwr2);this.indicesBuffer=r,this.distancesBuffer=o,this.calcDepthsPass=new de(e,t.positionsBuffer,this.distancesBuffer,this.indicesBuffer),this.bitonicSort=new ge(e,this.itemCountCeilPwr2,this.indicesBuffer,this.distancesBuffer),this.unrollIndicesPass=new ve(e,this.indicesBuffer,t.indicesBuffer,t.count)}static createBuffers(e,t){let r=e.createBuffer({label:"sortPassGPU.indices-buffer",size:t*ze,usage:GPUBufferUsage.STORAGE}),o=e.createBuffer({label:"sortPassGPU.distances-buffer",size:t*W,usage:GPUBufferUsage.STORAGE});return[r,o]}cmdSortByDepth(e){this.calcDepthsPass.cmdCalcDepths(e),this.bitonicSort.cmdSort(e),this.unrollIndicesPass.cmdUnrollIndices(e)}};var ar=4096,qe=256*256,He=class n{static NAME=n.name;sizeList;starts0;sortedSplatsIndices;unroledSortedSplatsIndices;constructor(e){let t=e.count;this.sizeList=new Int32Array(t),this.starts0=new Uint32Array(qe),this.sortedSplatsIndices=new Uint32Array(t),this.unroledSortedSplatsIndices=new Uint32Array(t*Y)}cmdSortByDepth(e){let{device:t,mvpMatrix:r,splats:o,profiler:i}=e,a=i?.startRegionCpu(n.NAME),s=o.count,[c,f]=this.calculateDepths(r,o),h=(f-c)/qe,l=new Uint32Array(qe);for(let d=0;d<s;d++){let v=(this.sizeList[d]-c)/h|0;this.sizeList[d]=v,l[v]++}let p=this.starts0;for(let d=1;d<qe;d++)p[d]=p[d-1]+l[d-1];for(let d=0;d<s;d++)this.sortedSplatsIndices[p[this.sizeList[d]]++]=d;an(this.sortedSplatsIndices,this.unroledSortedSplatsIndices,o.count),i?.endRegionCpu(a),sn(t,o,this.unroledSortedSplatsIndices)}calculateDepths(e,t){let r=-1/0,o=1/0;for(let i=0;i<t.count;i++){let a=Le(e,t.positions,4*i);a=Math.floor(a*ar),this.sizeList[i]=a,r=Math.max(r,a),o=Math.min(o,a)}return[o,r]}};function an(n,e,t){if(t!==n.length)throw new Error(`There are ${t} splats, but there are ${n.length} splat sorted indices. This number should match.`);for(let r=0;r<t;r++){let o=n[r];for(let i=0;i<Y;i++)e[r*Y+i]=o*Y+i}}function sn(n,e,t){n.queue.writeBuffer(e.indicesBuffer,0,t,0)}var sr=`
struct Uniforms {
  mvpMatrix: mat4x4<f32>,
  viewMatrix: mat4x4<f32>,
  scaleModifier: f32,
};
@binding(0) @group(0)
var<uniform> _uniforms: Uniforms;

const H:f32 = 0.0;

@vertex
fn ground_main_vs(
  @builtin(vertex_index) in_vertex_index : u32
) -> @builtin(position) vec4f {
  let squareScale = 1.0;
  var offsetX = f32(i32(in_vertex_index / 2u ) * 2 - 1); // [-1, -1, 0, 0]
  var offsetY = f32(i32(in_vertex_index & 1u) * 2 - 1); // [-1, 1, -1, 1, ...]
  offsetX = offsetX * squareScale;
  offsetY = offsetY * squareScale;

  var pos = vec4<f32>(offsetX, H, offsetY, 1.);
  var projectedPosition = _uniforms.mvpMatrix * pos;
  projectedPosition /= projectedPosition.w;
  return projectedPosition;
}

@fragment
fn ground_main_fs() -> @location(0) vec4f {
  let c = 0.9;
  return vec4(c, c, c, 1.0);
}
`,Ve=class n{static NAME=n.name;renderPipeline;uniformsBindings;constructor(e,t,r){this.renderPipeline=n.createRenderPipeline(e,t),this.uniformsBindings=n.assignResourcesToBindings(e,this.renderPipeline.getBindGroupLayout(0),r)}static createRenderPipeline(e,t){let r=e.createShaderModule({code:sr});return e.createRenderPipeline({label:"splats-render",layout:"auto",vertex:{module:r,entryPoint:"ground_main_vs",buffers:[]},fragment:{module:r,entryPoint:"ground_main_fs",targets:[{format:t}]},primitive:{cullMode:"none",topology:"triangle-strip",stripIndexFormat:void 0}})}static assignResourcesToBindings(e,t,r){return e.createBindGroup({layout:t,entries:[r.createBindingDesc(0)]})}draw(e,t){let{cmdBuf:r,profiler:o}=e,i=r.beginRenderPass({label:n.NAME,colorAttachments:[{view:t.createView(),loadOp:"clear",storeOp:"store",clearValue:[C.clearColor[0],C.clearColor[1],C.clearColor[2],0]}],timestampWrites:o?.createScopeGpu(n.NAME)});i.setPipeline(this.renderPipeline),i.setBindGroup(0,this.uniformsBindings),i.draw(4,1,0,0),i.end()}};var cr=[0,-1,0],je=class{viewMatrix;constructor(e=ne){this.viewMatrix=j.lookAt(e.position,e.target,cr)}translate(e,t,r){let o=j.inverse(this.viewMatrix);j.translate(o,[e,t,r],o),j.inverse(o,this.viewMatrix)}rotate(e,t,r){let o=j.inverse(this.viewMatrix);j.rotateX(o,t,o),j.rotateY(o,e,o),j.rotateZ(o,r,o),j.inverse(o,this.viewMatrix)}update(e,t){let r=(l,p)=>(l?1:0)-(p?1:0),o=e*C.movementSpeed,i=t.directions,a=o*r(i.right,i.left),s=o*r(i.up,i.down),c=o*r(i.backward,i.forward);this.translate(a,s,c);let f=t.mouse.x*e*C.rotationSpeed,h=t.mouse.y*e*C.rotationSpeed;f=lr(f,Math.PI*2),h=ur(h,-Math.PI/2,Math.PI/2),this.rotate(-f,-h,0)}};function ur(n,e,t){return Math.min(Math.max(n,e),t)}function lr(n,e){return n-Math.floor(Math.abs(n)/e)*e*Math.sign(n)}var Ye=class n{static NAME=n.name;arrayToSort;sortedSplatsIndices;unroledSortedSplatsIndices;constructor(e){let t=e.count;this.arrayToSort=On(t).map(r=>({depth:0,idx:0})),this.sortedSplatsIndices=new Uint32Array(t),this.unroledSortedSplatsIndices=new Uint32Array(t*Y)}cmdSortByDepth(e){let{device:t,mvpMatrix:r,splats:o,profiler:i}=e,a=i?.startRegionCpu(n.NAME);this.arrayToSort.forEach((s,c)=>{s.idx=c,s.depth=Le(r,o.positions,4*c)}),this.arrayToSort.sort((s,c)=>c.depth-s.depth),this.arrayToSort.forEach((s,c)=>{this.sortedSplatsIndices[c]=s.idx}),an(this.sortedSplatsIndices,this.unroledSortedSplatsIndices,o.count),i?.endRegionCpu(a),sn(t,o,this.unroledSortedSplatsIndices)}};function $n(n){Ee.SHADER_CODE=n.splatPassShader,ge.SHADER_CODE=n.sortBitonicShader,de.SHADER_CODE=n.sortCalcDeptsShader,ve.SHADER_CODE=n.sortUnrollIndicesShader}var Xe=class{renderUniformBuffer;cameraCtrl;projectionMat;splatPass;sortPassGPU;sortPassCPU;sortPassCPU_Naive;drawGroundPass;constructor(e,t,r,o){this.renderUniformBuffer=new _e(e),this.splatPass=new Ee(e,r,this.renderUniformBuffer,o),this.sortPassGPU=new Ne(e,o),this.sortPassCPU=new He(o),this.sortPassCPU_Naive=new Ye(o),this.drawGroundPass=new Ve(e,r,this.renderUniformBuffer),this.cameraCtrl=new je(ne),this.projectionMat=rn(t)}updateCamera(e,t){this.cameraCtrl.update(e,t)}onCanvasResize=e=>{this.projectionMat=rn(e)};cmdRender(e,t){let r=this.cameraCtrl.viewMatrix,o=Rn(r,this.projectionMat),i={...e,viewMatrix:r,mvpMatrix:o,projMatrix:this.projectionMat,focalX:this.projectionMat[0]*e.viewport.width*.5,focalY:this.projectionMat[5]*e.viewport.height*.5};C.sortMethod==="CPU"?this.sortPassCPU.cmdSortByDepth(i):C.sortMethod==="CPU_NAIVE"?this.sortPassCPU_Naive.cmdSortByDepth(i):this.sortPassGPU.cmdSortByDepth(i),this.renderUniformBuffer.update(i);let a="clear";C.drawGround&&(this.drawGroundPass.draw(i,t),a="load"),this.splatPass.draw(i,t,a)}};var Fn=3*W,Pe=Fn+3*W,We=Pe+4*Se,kn=n=>n/W;function zn(n,e){let r=e.length/on;console.log(`bytes: ${e.length} splats: ${r}`);let o=new Float32Array(e.buffer);if(o.length!==e.length/4)throw new Error(`File bytes (${e.length}) could not be reinterpreted as floats`);let i=new Float32Array(r*4),a=new Float32Array(r*4),s=new Float32Array(r*4),c=new Uint32Array(r);for(let g=0;g<r;g++){let _=g*on,y=kn(_);i[g*4+0]=o[y],i[g*4+1]=o[y+1],i[g*4+2]=o[y+2],i[g*4+3]=1;let b=kn(Fn);a[g*4+0]=o[y+b],a[g*4+1]=o[y+b+1],a[g*4+2]=o[y+b+2],a[g*4+3]=1;let w=S=>(S-128)/128;s[g*4+0]=w(e[_+We]),s[g*4+1]=w(e[_+We+1]),s[g*4+2]=w(e[_+We+2]),s[g*4+3]=w(e[_+We+3]),c[g]=Tn(e[_+Pe],e[_+Pe+1],e[_+Pe+2],e[_+Pe+3])}fr(i);let f=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,h=se(n,"splats-positions",f,i),l=se(n,"splats-rotations",f,s),p=se(n,"splats-scales",f,a),d=se(n,"splats-colors",f,c),v=n.createBuffer({label:"splats-indices",size:r*Y*ze,usage:GPUBufferUsage.INDEX|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});return{count:r,positions:i,positionsBuffer:h,colorsBuffer:d,rotationsBuffer:l,scalesBuffer:p,indicesBuffer:v}}function fr(n){let e=[n[0],n[1],n[2]],t=[n[0],n[1],n[2]],r=n.length/4;for(let i=0;i<r;i++){let a=i*4;for(let s=0;s<3;s++)e[s]=Math.max(e[s],n[a+s]),t[s]=Math.min(t[s],n[a+s])}let o=i=>"["+i.map(a=>a.toFixed(2)).join(",")+"]";console.log("Bounding box min:",o(t)),console.log("Bounding box max:",o(e))}var pr=.9,hr=1e3;function Ln(){let n=document.getElementById("stats-window"),e=document.createElement("p"),t=document.createElement("p");n.appendChild(e),n.appendChild(t),n.style.display="block";let r=performance.now(),o,i=r;return[()=>{r=performance.now()},()=>{let s=performance.now(),c=s-r;o===void 0?o=c:o=Gn(o,c,1-pr),s-i>hr&&(i=s,a())}];function a(){if(o===void 0)return;let s=1/o*1e3;e.innerHTML=`${s.toFixed(2)} fps`,t.innerHTML=`${o.toFixed(2)}ms`}}function mr(n){if(n&&!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=n,document.head.appendChild(e),n}}function we(n,e){var t=n.__state.conversionName.toString(),r=Math.round(n.r),o=Math.round(n.g),i=Math.round(n.b),a=n.a,s=Math.round(n.h),c=n.s.toFixed(1),f=n.v.toFixed(1);if(e||t==="THREE_CHAR_HEX"||t==="SIX_CHAR_HEX"){for(var h=n.hex.toString(16);h.length<6;)h="0"+h;return"#"+h}else{if(t==="CSS_RGB")return"rgb("+r+","+o+","+i+")";if(t==="CSS_RGBA")return"rgba("+r+","+o+","+i+","+a+")";if(t==="HEX")return"0x"+n.hex.toString(16);if(t==="RGB_ARRAY")return"["+r+","+o+","+i+"]";if(t==="RGBA_ARRAY")return"["+r+","+o+","+i+","+a+"]";if(t==="RGB_OBJ")return"{r:"+r+",g:"+o+",b:"+i+"}";if(t==="RGBA_OBJ")return"{r:"+r+",g:"+o+",b:"+i+",a:"+a+"}";if(t==="HSV_OBJ")return"{h:"+s+",s:"+c+",v:"+f+"}";if(t==="HSVA_OBJ")return"{h:"+s+",s:"+c+",v:"+f+",a:"+a+"}"}return"unknown format"}var Nn=Array.prototype.forEach,Ce=Array.prototype.slice,m={BREAK:{},extend:function(e){return this.each(Ce.call(arguments,1),function(t){var r=this.isObject(t)?Object.keys(t):[];r.forEach((function(o){this.isUndefined(t[o])||(e[o]=t[o])}).bind(this))},this),e},defaults:function(e){return this.each(Ce.call(arguments,1),function(t){var r=this.isObject(t)?Object.keys(t):[];r.forEach((function(o){this.isUndefined(e[o])&&(e[o]=t[o])}).bind(this))},this),e},compose:function(){var e=Ce.call(arguments);return function(){for(var t=Ce.call(arguments),r=e.length-1;r>=0;r--)t=[e[r].apply(this,t)];return t[0]}},each:function(e,t,r){if(e){if(Nn&&e.forEach&&e.forEach===Nn)e.forEach(t,r);else if(e.length===e.length+0){var o=void 0,i=void 0;for(o=0,i=e.length;o<i;o++)if(o in e&&t.call(r,e[o],o)===this.BREAK)return}else for(var a in e)if(t.call(r,e[a],a)===this.BREAK)return}},defer:function(e){setTimeout(e,0)},debounce:function(e,t,r){var o=void 0;return function(){var i=this,a=arguments;function s(){o=null,r||e.apply(i,a)}var c=r||!o;clearTimeout(o),o=setTimeout(s,t),c&&e.apply(i,a)}},toArray:function(e){return e.toArray?e.toArray():Ce.call(e)},isUndefined:function(e){return e===void 0},isNull:function(e){return e===null},isNaN:function(n){function e(t){return n.apply(this,arguments)}return e.toString=function(){return n.toString()},e}(function(n){return isNaN(n)}),isArray:Array.isArray||function(n){return n.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return e===!1||e===!0},isFunction:function(e){return e instanceof Function}},_r=[{litmus:m.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return t===null?!1:{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:we},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return t===null?!1:{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:we},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return t===null?!1:{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:we},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return t===null?!1:{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:we}}},{litmus:m.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:m.isArray,conversions:{RGB_ARRAY:{read:function(e){return e.length!==3?!1:{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return e.length!==4?!1:{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:m.isObject,conversions:{RGBA_OBJ:{read:function(e){return m.isNumber(e.r)&&m.isNumber(e.g)&&m.isNumber(e.b)&&m.isNumber(e.a)?{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return m.isNumber(e.r)&&m.isNumber(e.g)&&m.isNumber(e.b)?{space:"RGB",r:e.r,g:e.g,b:e.b}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return m.isNumber(e.h)&&m.isNumber(e.s)&&m.isNumber(e.v)&&m.isNumber(e.a)?{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return m.isNumber(e.h)&&m.isNumber(e.s)&&m.isNumber(e.v)?{space:"HSV",h:e.h,s:e.s,v:e.v}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],Ae=void 0,Ke=void 0,un=function(){Ke=!1;var e=arguments.length>1?m.toArray(arguments):arguments[0];return m.each(_r,function(t){if(t.litmus(e))return m.each(t.conversions,function(r,o){if(Ae=r.read(e),Ke===!1&&Ae!==!1)return Ke=Ae,Ae.conversionName=o,Ae.conversion=r,m.BREAK}),m.BREAK}),Ke},qn=void 0,Ze={hsv_to_rgb:function(e,t,r){var o=Math.floor(e/60)%6,i=e/60-Math.floor(e/60),a=r*(1-t),s=r*(1-i*t),c=r*(1-(1-i)*t),f=[[r,c,a],[s,r,a],[a,r,c],[a,s,r],[c,a,r],[r,a,s]][o];return{r:f[0]*255,g:f[1]*255,b:f[2]*255}},rgb_to_hsv:function(e,t,r){var o=Math.min(e,t,r),i=Math.max(e,t,r),a=i-o,s=void 0,c=void 0;if(i!==0)c=a/i;else return{h:NaN,s:0,v:0};return e===i?s=(t-r)/a:t===i?s=2+(r-e)/a:s=4+(e-t)/a,s/=6,s<0&&(s+=1),{h:s*360,s:c,v:i/255}},rgb_to_hex:function(e,t,r){var o=this.hex_with_component(0,2,e);return o=this.hex_with_component(o,1,t),o=this.hex_with_component(o,0,r),o},component_from_hex:function(e,t){return e>>t*8&255},hex_with_component:function(e,t,r){return r<<(qn=t*8)|e&~(255<<qn)}},gr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},K=function(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")},Q=function(){function n(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),re=function n(e,t,r){e===null&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(o===void 0){var i=Object.getPrototypeOf(e);return i===null?void 0:n(i,t,r)}else{if("value"in o)return o.value;var a=o.get;return a===void 0?void 0:a.call(r)}},oe=function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(n,e):n.__proto__=e)},ie=function(n,e){if(!n)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:n},R=function(){function n(){if(K(this,n),this.__state=un.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return Q(n,[{key:"toString",value:function(){return we(this)}},{key:"toHexString",value:function(){return we(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),n}();function _n(n,e,t){Object.defineProperty(n,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(R.recalculateRGB(this,e,t),this.__state[e])},set:function(o){this.__state.space!=="RGB"&&(R.recalculateRGB(this,e,t),this.__state.space="RGB"),this.__state[e]=o}})}function gn(n,e){Object.defineProperty(n,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(R.recalculateHSV(this),this.__state[e])},set:function(r){this.__state.space!=="HSV"&&(R.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=r}})}R.recalculateRGB=function(n,e,t){if(n.__state.space==="HEX")n.__state[e]=Ze.component_from_hex(n.__state.hex,t);else if(n.__state.space==="HSV")m.extend(n.__state,Ze.hsv_to_rgb(n.__state.h,n.__state.s,n.__state.v));else throw new Error("Corrupted color state")};R.recalculateHSV=function(n){var e=Ze.rgb_to_hsv(n.r,n.g,n.b);m.extend(n.__state,{s:e.s,v:e.v}),m.isNaN(e.h)?m.isUndefined(n.__state.h)&&(n.__state.h=0):n.__state.h=e.h};R.COMPONENTS=["r","g","b","h","s","v","hex","a"];_n(R.prototype,"r",2);_n(R.prototype,"g",1);_n(R.prototype,"b",0);gn(R.prototype,"h");gn(R.prototype,"s");gn(R.prototype,"v");Object.defineProperty(R.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}});Object.defineProperty(R.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=Ze.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var ce=function(){function n(e,t){K(this,n),this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onChange=void 0,this.__onFinishChange=void 0}return Q(n,[{key:"onChange",value:function(t){return this.__onChange=t,this}},{key:"onFinishChange",value:function(t){return this.__onFinishChange=t,this}},{key:"setValue",value:function(t){return this.object[this.property]=t,this.__onChange&&this.__onChange.call(this,t),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),n}(),dr={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},Jn={};m.each(dr,function(n,e){m.each(n,function(t){Jn[t]=e})});var vr=/(\d+(\.\d+)?)px/;function Z(n){if(n==="0"||m.isUndefined(n))return 0;var e=n.match(vr);return m.isNull(e)?0:parseFloat(e[1])}var u={makeSelectable:function(e,t){e===void 0||e.style===void 0||(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,r){var o=r,i=t;m.isUndefined(i)&&(i=!0),m.isUndefined(o)&&(o=!0),e.style.position="absolute",i&&(e.style.left=0,e.style.right=0),o&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,r,o){var i=r||{},a=Jn[t];if(!a)throw new Error("Event type "+t+" not supported.");var s=document.createEvent(a);switch(a){case"MouseEvents":{var c=i.x||i.clientX||0,f=i.y||i.clientY||0;s.initMouseEvent(t,i.bubbles||!1,i.cancelable||!0,window,i.clickCount||1,0,0,c,f,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var h=s.initKeyboardEvent||s.initKeyEvent;m.defaults(i,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),h(t,i.bubbles||!1,i.cancelable,window,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,i.keyCode,i.charCode);break}default:{s.initEvent(t,i.bubbles||!1,i.cancelable||!0);break}}m.defaults(s,o),e.dispatchEvent(s)},bind:function(e,t,r,o){var i=o||!1;return e.addEventListener?e.addEventListener(t,r,i):e.attachEvent&&e.attachEvent("on"+t,r),u},unbind:function(e,t,r,o){var i=o||!1;return e.removeEventListener?e.removeEventListener(t,r,i):e.detachEvent&&e.detachEvent("on"+t,r),u},addClass:function(e,t){if(e.className===void 0)e.className=t;else if(e.className!==t){var r=e.className.split(/ +/);r.indexOf(t)===-1&&(r.push(t),e.className=r.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return u},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var r=e.className.split(/ +/),o=r.indexOf(t);o!==-1&&(r.splice(o,1),e.className=r.join(" "))}else e.className=void 0;return u},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return Z(t["border-left-width"])+Z(t["border-right-width"])+Z(t["padding-left"])+Z(t["padding-right"])+Z(t.width)},getHeight:function(e){var t=getComputedStyle(e);return Z(t["border-top-width"])+Z(t["border-bottom-width"])+Z(t["padding-top"])+Z(t["padding-bottom"])+Z(t.height)},getOffset:function(e){var t=e,r={left:0,top:0};if(t.offsetParent)do r.left+=t.offsetLeft,r.top+=t.offsetTop,t=t.offsetParent;while(t);return r},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},et=function(n){oe(e,n);function e(t,r){K(this,e);var o=ie(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),i=o;o.__prev=o.getValue(),o.__checkbox=document.createElement("input"),o.__checkbox.setAttribute("type","checkbox");function a(){i.setValue(!i.__prev)}return u.bind(o.__checkbox,"change",a,!1),o.domElement.appendChild(o.__checkbox),o.updateDisplay(),o}return Q(e,[{key:"setValue",value:function(r){var o=re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),o}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(ce),yr=function(n){oe(e,n);function e(t,r,o){K(this,e);var i=ie(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),a=o,s=i;if(i.__select=document.createElement("select"),m.isArray(a)){var c={};m.each(a,function(f){c[f]=f}),a=c}return m.each(a,function(f,h){var l=document.createElement("option");l.innerHTML=h,l.setAttribute("value",f),s.__select.appendChild(l)}),i.updateDisplay(),u.bind(i.__select,"change",function(){var f=this.options[this.selectedIndex].value;s.setValue(f)}),i.domElement.appendChild(i.__select),i}return Q(e,[{key:"setValue",value:function(r){var o=re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),o}},{key:"updateDisplay",value:function(){return u.isActive(this.__select)?this:(this.__select.value=this.getValue(),re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e}(ce),br=function(n){oe(e,n);function e(t,r){K(this,e);var o=ie(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),i=o;function a(){i.setValue(i.__input.value)}function s(){i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}return o.__input=document.createElement("input"),o.__input.setAttribute("type","text"),u.bind(o.__input,"keyup",a),u.bind(o.__input,"change",a),u.bind(o.__input,"blur",s),u.bind(o.__input,"keydown",function(c){c.keyCode===13&&this.blur()}),o.updateDisplay(),o.domElement.appendChild(o.__input),o}return Q(e,[{key:"updateDisplay",value:function(){return u.isActive(this.__input)||(this.__input.value=this.getValue()),re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(ce);function Hn(n){var e=n.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var nt=function(n){oe(e,n);function e(t,r,o){K(this,e);var i=ie(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),a=o||{};return i.__min=a.min,i.__max=a.max,i.__step=a.step,m.isUndefined(i.__step)?i.initialValue===0?i.__impliedStep=1:i.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(i.initialValue))/Math.LN10))/10:i.__impliedStep=i.__step,i.__precision=Hn(i.__impliedStep),i}return Q(e,[{key:"setValue",value:function(r){var o=r;return this.__min!==void 0&&o<this.__min?o=this.__min:this.__max!==void 0&&o>this.__max&&(o=this.__max),this.__step!==void 0&&o%this.__step!==0&&(o=Math.round(o/this.__step)*this.__step),re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,o)}},{key:"min",value:function(r){return this.__min=r,this}},{key:"max",value:function(r){return this.__max=r,this}},{key:"step",value:function(r){return this.__step=r,this.__impliedStep=r,this.__precision=Hn(r),this}}]),e}(ce);function wr(n,e){var t=Math.pow(10,e);return Math.round(n*t)/t}var Je=function(n){oe(e,n);function e(t,r,o){K(this,e);var i=ie(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r,o));i.__truncationSuspended=!1;var a=i,s=void 0;function c(){var v=parseFloat(a.__input.value);m.isNaN(v)||a.setValue(v)}function f(){a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function h(){f()}function l(v){var g=s-v.clientY;a.setValue(a.getValue()+g*a.__impliedStep),s=v.clientY}function p(){u.unbind(window,"mousemove",l),u.unbind(window,"mouseup",p),f()}function d(v){u.bind(window,"mousemove",l),u.bind(window,"mouseup",p),s=v.clientY}return i.__input=document.createElement("input"),i.__input.setAttribute("type","text"),u.bind(i.__input,"change",c),u.bind(i.__input,"blur",h),u.bind(i.__input,"mousedown",d),u.bind(i.__input,"keydown",function(v){v.keyCode===13&&(a.__truncationSuspended=!0,this.blur(),a.__truncationSuspended=!1,f())}),i.updateDisplay(),i.domElement.appendChild(i.__input),i}return Q(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():wr(this.getValue(),this.__precision),re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(nt);function Vn(n,e,t,r,o){return r+(o-r)*((n-e)/(t-e))}var ln=function(n){oe(e,n);function e(t,r,o,i,a){K(this,e);var s=ie(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r,{min:o,max:i,step:a})),c=s;s.__background=document.createElement("div"),s.__foreground=document.createElement("div"),u.bind(s.__background,"mousedown",f),u.bind(s.__background,"touchstart",p),u.addClass(s.__background,"slider"),u.addClass(s.__foreground,"slider-fg");function f(g){document.activeElement.blur(),u.bind(window,"mousemove",h),u.bind(window,"mouseup",l),h(g)}function h(g){g.preventDefault();var _=c.__background.getBoundingClientRect();return c.setValue(Vn(g.clientX,_.left,_.right,c.__min,c.__max)),!1}function l(){u.unbind(window,"mousemove",h),u.unbind(window,"mouseup",l),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}function p(g){g.touches.length===1&&(u.bind(window,"touchmove",d),u.bind(window,"touchend",v),d(g))}function d(g){var _=g.touches[0].clientX,y=c.__background.getBoundingClientRect();c.setValue(Vn(_,y.left,y.right,c.__min,c.__max))}function v(){u.unbind(window,"touchmove",d),u.unbind(window,"touchend",v),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}return s.updateDisplay(),s.__background.appendChild(s.__foreground),s.domElement.appendChild(s.__background),s}return Q(e,[{key:"updateDisplay",value:function(){var r=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=r*100+"%",re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(nt),tt=function(n){oe(e,n);function e(t,r,o){K(this,e);var i=ie(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),a=i;return i.__button=document.createElement("div"),i.__button.innerHTML=o===void 0?"Fire":o,u.bind(i.__button,"click",function(s){return s.preventDefault(),a.fire(),!1}),u.addClass(i.__button,"button"),i.domElement.appendChild(i.__button),i}return Q(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e}(ce),fn=function(n){oe(e,n);function e(t,r){K(this,e);var o=ie(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r));o.__color=new R(o.getValue()),o.__temp=new R(0);var i=o;o.domElement=document.createElement("div"),u.makeSelectable(o.domElement,!1),o.__selector=document.createElement("div"),o.__selector.className="selector",o.__saturation_field=document.createElement("div"),o.__saturation_field.className="saturation-field",o.__field_knob=document.createElement("div"),o.__field_knob.className="field-knob",o.__field_knob_border="2px solid ",o.__hue_knob=document.createElement("div"),o.__hue_knob.className="hue-knob",o.__hue_field=document.createElement("div"),o.__hue_field.className="hue-field",o.__input=document.createElement("input"),o.__input.type="text",o.__input_textShadow="0 1px 1px ",u.bind(o.__input,"keydown",function(g){g.keyCode===13&&l.call(this)}),u.bind(o.__input,"blur",l),u.bind(o.__selector,"mousedown",function(){u.addClass(this,"drag").bind(window,"mouseup",function(){u.removeClass(i.__selector,"drag")})}),u.bind(o.__selector,"touchstart",function(){u.addClass(this,"drag").bind(window,"touchend",function(){u.removeClass(i.__selector,"drag")})});var a=document.createElement("div");m.extend(o.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),m.extend(o.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:o.__field_knob_border+(o.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),m.extend(o.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),m.extend(o.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),m.extend(a.style,{width:"100%",height:"100%",background:"none"}),jn(a,"top","rgba(0,0,0,0)","#000"),m.extend(o.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),Sr(o.__hue_field),m.extend(o.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:o.__input_textShadow+"rgba(0,0,0,0.7)"}),u.bind(o.__saturation_field,"mousedown",s),u.bind(o.__saturation_field,"touchstart",s),u.bind(o.__field_knob,"mousedown",s),u.bind(o.__field_knob,"touchstart",s),u.bind(o.__hue_field,"mousedown",c),u.bind(o.__hue_field,"touchstart",c);function s(g){d(g),u.bind(window,"mousemove",d),u.bind(window,"touchmove",d),u.bind(window,"mouseup",f),u.bind(window,"touchend",f)}function c(g){v(g),u.bind(window,"mousemove",v),u.bind(window,"touchmove",v),u.bind(window,"mouseup",h),u.bind(window,"touchend",h)}function f(){u.unbind(window,"mousemove",d),u.unbind(window,"touchmove",d),u.unbind(window,"mouseup",f),u.unbind(window,"touchend",f),p()}function h(){u.unbind(window,"mousemove",v),u.unbind(window,"touchmove",v),u.unbind(window,"mouseup",h),u.unbind(window,"touchend",h),p()}function l(){var g=un(this.value);g!==!1?(i.__color.__state=g,i.setValue(i.__color.toOriginal())):this.value=i.__color.toString()}function p(){i.__onFinishChange&&i.__onFinishChange.call(i,i.__color.toOriginal())}o.__saturation_field.appendChild(a),o.__selector.appendChild(o.__field_knob),o.__selector.appendChild(o.__saturation_field),o.__selector.appendChild(o.__hue_field),o.__hue_field.appendChild(o.__hue_knob),o.domElement.appendChild(o.__input),o.domElement.appendChild(o.__selector),o.updateDisplay();function d(g){g.type.indexOf("touch")===-1&&g.preventDefault();var _=i.__saturation_field.getBoundingClientRect(),y=g.touches&&g.touches[0]||g,b=y.clientX,w=y.clientY,S=(b-_.left)/(_.right-_.left),M=1-(w-_.top)/(_.bottom-_.top);return M>1?M=1:M<0&&(M=0),S>1?S=1:S<0&&(S=0),i.__color.v=M,i.__color.s=S,i.setValue(i.__color.toOriginal()),!1}function v(g){g.type.indexOf("touch")===-1&&g.preventDefault();var _=i.__hue_field.getBoundingClientRect(),y=g.touches&&g.touches[0]||g,b=y.clientY,w=1-(b-_.top)/(_.bottom-_.top);return w>1?w=1:w<0&&(w=0),i.__color.h=w*360,i.setValue(i.__color.toOriginal()),!1}return o}return Q(e,[{key:"updateDisplay",value:function(){var r=un(this.getValue());if(r!==!1){var o=!1;m.each(R.COMPONENTS,function(s){if(!m.isUndefined(r[s])&&!m.isUndefined(this.__color.__state[s])&&r[s]!==this.__color.__state[s])return o=!0,{}},this),o&&m.extend(this.__color.__state,r)}m.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var i=this.__color.v<.5||this.__color.s>.5?255:0,a=255-i;m.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+i+","+i+","+i+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,jn(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),m.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+i+","+i+","+i+")",textShadow:this.__input_textShadow+"rgba("+a+","+a+","+a+",.7)"})}}]),e}(ce),xr=["-moz-","-o-","-webkit-","-ms-",""];function jn(n,e,t,r){n.style.background="",m.each(xr,function(o){n.style.cssText+="background: "+o+"linear-gradient("+e+", "+t+" 0%, "+r+" 100%); "})}function Sr(n){n.style.background="",n.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",n.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",n.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",n.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",n.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var Er={load:function(e,t){var r=t||document,o=r.createElement("link");o.type="text/css",o.rel="stylesheet",o.href=e,r.getElementsByTagName("head")[0].appendChild(o)},inject:function(e,t){var r=t||document,o=document.createElement("style");o.type="text/css",o.innerHTML=e;var i=r.getElementsByTagName("head")[0];try{i.appendChild(o)}catch{}}},Pr=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,Cr=function(e,t){var r=e[t];return m.isArray(arguments[2])||m.isObject(arguments[2])?new yr(e,t,arguments[2]):m.isNumber(r)?m.isNumber(arguments[2])&&m.isNumber(arguments[3])?m.isNumber(arguments[4])?new ln(e,t,arguments[2],arguments[3],arguments[4]):new ln(e,t,arguments[2],arguments[3]):m.isNumber(arguments[4])?new Je(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new Je(e,t,{min:arguments[2],max:arguments[3]}):m.isString(r)?new br(e,t):m.isFunction(r)?new tt(e,t,""):m.isBoolean(r)?new et(e,t):null};function Ar(n){setTimeout(n,1e3/60)}var Mr=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Ar,Br=function(){function n(){K(this,n),this.backgroundElement=document.createElement("div"),m.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),u.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),m.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;u.bind(this.backgroundElement,"click",function(){e.hide()})}return Q(n,[{key:"show",value:function(){var t=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),m.defer(function(){t.backgroundElement.style.opacity=1,t.domElement.style.opacity=1,t.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var t=this,r=function o(){t.domElement.style.display="none",t.backgroundElement.style.display="none",u.unbind(t.domElement,"webkitTransitionEnd",o),u.unbind(t.domElement,"transitionend",o),u.unbind(t.domElement,"oTransitionEnd",o)};u.bind(this.domElement,"webkitTransitionEnd",r),u.bind(this.domElement,"transitionend",r),u.bind(this.domElement,"oTransitionEnd",r),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-u.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-u.getHeight(this.domElement)/2+"px"}}]),n}(),Rr=mr(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);Er.inject(Rr);var Yn="dg",Xn=72,Wn=20,Te="Default",Me=function(){try{return!!window.localStorage}catch{return!1}}(),Be=void 0,Kn=!0,ye=void 0,cn=!1,rt=[],A=function n(e){var t=this,r=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),u.addClass(this.domElement,Yn),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],r=m.defaults(r,{closeOnTop:!1,autoPlace:!0,width:n.DEFAULT_WIDTH}),r=m.defaults(r,{resizable:r.autoPlace,hideable:r.autoPlace}),m.isUndefined(r.load)?r.load={preset:Te}:r.preset&&(r.load.preset=r.preset),m.isUndefined(r.parent)&&r.hideable&&rt.push(this),r.resizable=m.isUndefined(r.parent)&&r.resizable,r.autoPlace&&m.isUndefined(r.scrollable)&&(r.scrollable=!0);var o=Me&&localStorage.getItem(be(this,"isLocal"))==="true",i=void 0,a=void 0;if(Object.defineProperties(this,{parent:{get:function(){return r.parent}},scrollable:{get:function(){return r.scrollable}},autoPlace:{get:function(){return r.autoPlace}},closeOnTop:{get:function(){return r.closeOnTop}},preset:{get:function(){return t.parent?t.getRoot().preset:r.load.preset},set:function(p){t.parent?t.getRoot().preset=p:r.load.preset=p,Gr(this),t.revert()}},width:{get:function(){return r.width},set:function(p){r.width=p,mn(t,p)}},name:{get:function(){return r.name},set:function(p){r.name=p,a&&(a.innerHTML=r.name)}},closed:{get:function(){return r.closed},set:function(p){r.closed=p,r.closed?u.addClass(t.__ul,n.CLASS_CLOSED):u.removeClass(t.__ul,n.CLASS_CLOSED),this.onResize(),t.__closeButton&&(t.__closeButton.innerHTML=p?n.TEXT_OPEN:n.TEXT_CLOSED)}},load:{get:function(){return r.load}},useLocalStorage:{get:function(){return o},set:function(p){Me&&(o=p,p?u.bind(window,"unload",i):u.unbind(window,"unload",i),localStorage.setItem(be(t,"isLocal"),p))}}}),m.isUndefined(r.parent)){if(this.closed=r.closed||!1,u.addClass(this.domElement,n.CLASS_MAIN),u.makeSelectable(this.domElement,!1),Me&&o){t.useLocalStorage=!0;var s=localStorage.getItem(be(this,"gui"));s&&(r.load=JSON.parse(s))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=n.TEXT_CLOSED,u.addClass(this.__closeButton,n.CLASS_CLOSE_BUTTON),r.closeOnTop?(u.addClass(this.__closeButton,n.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(u.addClass(this.__closeButton,n.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),u.bind(this.__closeButton,"click",function(){t.closed=!t.closed})}else{r.closed===void 0&&(r.closed=!0);var c=document.createTextNode(r.name);u.addClass(c,"controller-name"),a=dn(t,c);var f=function(p){return p.preventDefault(),t.closed=!t.closed,!1};u.addClass(this.__ul,n.CLASS_CLOSED),u.addClass(a,"title"),u.bind(a,"click",f),r.closed||(this.closed=!1)}r.autoPlace&&(m.isUndefined(r.parent)&&(Kn&&(ye=document.createElement("div"),u.addClass(ye,Yn),u.addClass(ye,n.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(ye),Kn=!1),ye.appendChild(this.domElement),u.addClass(this.domElement,n.CLASS_AUTO_PLACE)),this.parent||mn(t,r.width)),this.__resizeHandler=function(){t.onResizeDebounced()},u.bind(window,"resize",this.__resizeHandler),u.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),u.bind(this.__ul,"transitionend",this.__resizeHandler),u.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),r.resizable&&Or(this),i=function(){Me&&localStorage.getItem(be(t,"isLocal"))==="true"&&localStorage.setItem(be(t,"gui"),JSON.stringify(t.getSaveObject()))},this.saveToLocalStorageIfPossible=i;function h(){var l=t.getRoot();l.width+=1,m.defer(function(){l.width-=1})}r.parent||h()};A.toggleHide=function(){cn=!cn,m.each(rt,function(n){n.domElement.style.display=cn?"none":""})};A.CLASS_AUTO_PLACE="a";A.CLASS_AUTO_PLACE_CONTAINER="ac";A.CLASS_MAIN="main";A.CLASS_CONTROLLER_ROW="cr";A.CLASS_TOO_TALL="taller-than-window";A.CLASS_CLOSED="closed";A.CLASS_CLOSE_BUTTON="close-button";A.CLASS_CLOSE_TOP="close-top";A.CLASS_CLOSE_BOTTOM="close-bottom";A.CLASS_DRAG="drag";A.DEFAULT_WIDTH=245;A.TEXT_CLOSED="Close Controls";A.TEXT_OPEN="Open Controls";A._keydownHandler=function(n){document.activeElement.type!=="text"&&(n.which===Xn||n.keyCode===Xn)&&A.toggleHide()};u.bind(window,"keydown",A._keydownHandler,!1);m.extend(A.prototype,{add:function(e,t){return Re(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return Re(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;m.defer(function(){t.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&ye.removeChild(this.domElement);var e=this;m.each(this.__folders,function(t){e.removeFolder(t)}),u.unbind(window,"keydown",A._keydownHandler,!1),Qn(this)},addFolder:function(e){if(this.__folders[e]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var r=new A(t);this.__folders[e]=r;var o=dn(this,r.domElement);return u.addClass(o,"folder"),r},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],Qn(e);var t=this;m.each(e.__folders,function(r){e.removeFolder(r)}),m.defer(function(){t.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=u.getOffset(e.__ul).top,r=0;m.each(e.__ul.childNodes,function(o){e.autoPlace&&o===e.__save_row||(r+=u.getHeight(o))}),window.innerHeight-t-Wn<r?(u.addClass(e.domElement,A.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-Wn+"px"):(u.removeClass(e.domElement,A.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&m.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:m.debounce(function(){this.onResize()},50),remember:function(){if(m.isUndefined(Be)&&(Be=new Br,Be.domElement.innerHTML=Pr),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;m.each(Array.prototype.slice.call(arguments),function(t){e.__rememberedObjects.length===0&&Ur(e),e.__rememberedObjects.indexOf(t)===-1&&e.__rememberedObjects.push(t)}),this.autoPlace&&mn(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=Qe(this)),e.folders={},m.each(this.__folders,function(t,r){e.folders[r]=t.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=Qe(this),pn(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered[Te]=Qe(this,!0)),this.load.remembered[e]=Qe(this),this.preset=e,hn(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){m.each(this.__controllers,function(t){this.getRoot().load.remembered?ot(e||this.getRoot(),t):t.setValue(t.initialValue),t.__onFinishChange&&t.__onFinishChange.call(t,t.getValue())},this),m.each(this.__folders,function(t){t.revert(t)}),e||pn(this.getRoot(),!1)},listen:function(e){var t=this.__listening.length===0;this.__listening.push(e),t&&it(this.__listening)},updateDisplay:function(){m.each(this.__controllers,function(e){e.updateDisplay()}),m.each(this.__folders,function(e){e.updateDisplay()})}});function dn(n,e,t){var r=document.createElement("li");return e&&r.appendChild(e),t?n.__ul.insertBefore(r,t):n.__ul.appendChild(r),n.onResize(),r}function Qn(n){u.unbind(window,"resize",n.__resizeHandler),n.saveToLocalStorageIfPossible&&u.unbind(window,"unload",n.saveToLocalStorageIfPossible)}function pn(n,e){var t=n.__preset_select[n.__preset_select.selectedIndex];e?t.innerHTML=t.value+"*":t.innerHTML=t.value}function Tr(n,e,t){if(t.__li=e,t.__gui=n,m.extend(t,{options:function(a){if(arguments.length>1){var s=t.__li.nextElementSibling;return t.remove(),Re(n,t.object,t.property,{before:s,factoryArgs:[m.toArray(arguments)]})}if(m.isArray(a)||m.isObject(a)){var c=t.__li.nextElementSibling;return t.remove(),Re(n,t.object,t.property,{before:c,factoryArgs:[a]})}},name:function(a){return t.__li.firstElementChild.firstElementChild.innerHTML=a,t},listen:function(){return t.__gui.listen(t),t},remove:function(){return t.__gui.remove(t),t}}),t instanceof ln){var r=new Je(t.object,t.property,{min:t.__min,max:t.__max,step:t.__step});m.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(i){var a=t[i],s=r[i];t[i]=r[i]=function(){var c=Array.prototype.slice.call(arguments);return s.apply(r,c),a.apply(t,c)}}),u.addClass(e,"has-slider"),t.domElement.insertBefore(r.domElement,t.domElement.firstElementChild)}else if(t instanceof Je){var o=function(a){if(m.isNumber(t.__min)&&m.isNumber(t.__max)){var s=t.__li.firstElementChild.firstElementChild.innerHTML,c=t.__gui.__listening.indexOf(t)>-1;t.remove();var f=Re(n,t.object,t.property,{before:t.__li.nextElementSibling,factoryArgs:[t.__min,t.__max,t.__step]});return f.name(s),c&&f.listen(),f}return a};t.min=m.compose(o,t.min),t.max=m.compose(o,t.max)}else t instanceof et?(u.bind(e,"click",function(){u.fakeEvent(t.__checkbox,"click")}),u.bind(t.__checkbox,"click",function(i){i.stopPropagation()})):t instanceof tt?(u.bind(e,"click",function(){u.fakeEvent(t.__button,"click")}),u.bind(e,"mouseover",function(){u.addClass(t.__button,"hover")}),u.bind(e,"mouseout",function(){u.removeClass(t.__button,"hover")})):t instanceof fn&&(u.addClass(e,"color"),t.updateDisplay=m.compose(function(i){return e.style.borderLeftColor=t.__color.toString(),i},t.updateDisplay),t.updateDisplay());t.setValue=m.compose(function(i){return n.getRoot().__preset_select&&t.isModified()&&pn(n.getRoot(),!0),i},t.setValue)}function ot(n,e){var t=n.getRoot(),r=t.__rememberedObjects.indexOf(e.object);if(r!==-1){var o=t.__rememberedObjectIndecesToControllers[r];if(o===void 0&&(o={},t.__rememberedObjectIndecesToControllers[r]=o),o[e.property]=e,t.load&&t.load.remembered){var i=t.load.remembered,a=void 0;if(i[n.preset])a=i[n.preset];else if(i[Te])a=i[Te];else return;if(a[r]&&a[r][e.property]!==void 0){var s=a[r][e.property];e.initialValue=s,e.setValue(s)}}}}function Re(n,e,t,r){if(e[t]===void 0)throw new Error('Object "'+e+'" has no property "'+t+'"');var o=void 0;if(r.color)o=new fn(e,t);else{var i=[e,t].concat(r.factoryArgs);o=Cr.apply(n,i)}r.before instanceof ce&&(r.before=r.before.__li),ot(n,o),u.addClass(o.domElement,"c");var a=document.createElement("span");u.addClass(a,"property-name"),a.innerHTML=o.property;var s=document.createElement("div");s.appendChild(a),s.appendChild(o.domElement);var c=dn(n,s,r.before);return u.addClass(c,A.CLASS_CONTROLLER_ROW),o instanceof fn?u.addClass(c,"color"):u.addClass(c,gr(o.getValue())),Tr(n,c,o),n.__controllers.push(o),o}function be(n,e){return document.location.href+"."+e}function hn(n,e,t){var r=document.createElement("option");r.innerHTML=e,r.value=e,n.__preset_select.appendChild(r),t&&(n.__preset_select.selectedIndex=n.__preset_select.length-1)}function Zn(n,e){e.style.display=n.useLocalStorage?"block":"none"}function Ur(n){var e=n.__save_row=document.createElement("li");u.addClass(n.domElement,"has-save"),n.__ul.insertBefore(e,n.__ul.firstChild),u.addClass(e,"save-row");var t=document.createElement("span");t.innerHTML="&nbsp;",u.addClass(t,"button gears");var r=document.createElement("span");r.innerHTML="Save",u.addClass(r,"button"),u.addClass(r,"save");var o=document.createElement("span");o.innerHTML="New",u.addClass(o,"button"),u.addClass(o,"save-as");var i=document.createElement("span");i.innerHTML="Revert",u.addClass(i,"button"),u.addClass(i,"revert");var a=n.__preset_select=document.createElement("select");if(n.load&&n.load.remembered?m.each(n.load.remembered,function(l,p){hn(n,p,p===n.preset)}):hn(n,Te,!1),u.bind(a,"change",function(){for(var l=0;l<n.__preset_select.length;l++)n.__preset_select[l].innerHTML=n.__preset_select[l].value;n.preset=this.value}),e.appendChild(a),e.appendChild(t),e.appendChild(r),e.appendChild(o),e.appendChild(i),Me){var s=document.getElementById("dg-local-explain"),c=document.getElementById("dg-local-storage"),f=document.getElementById("dg-save-locally");f.style.display="block",localStorage.getItem(be(n,"isLocal"))==="true"&&c.setAttribute("checked","checked"),Zn(n,s),u.bind(c,"change",function(){n.useLocalStorage=!n.useLocalStorage,Zn(n,s)})}var h=document.getElementById("dg-new-constructor");u.bind(h,"keydown",function(l){l.metaKey&&(l.which===67||l.keyCode===67)&&Be.hide()}),u.bind(t,"click",function(){h.innerHTML=JSON.stringify(n.getSaveObject(),void 0,2),Be.show(),h.focus(),h.select()}),u.bind(r,"click",function(){n.save()}),u.bind(o,"click",function(){var l=prompt("Enter a new preset name.");l&&n.saveAs(l)}),u.bind(i,"click",function(){n.revert()})}function Or(n){var e=void 0;n.__resize_handle=document.createElement("div"),m.extend(n.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function t(i){return i.preventDefault(),n.width+=e-i.clientX,n.onResize(),e=i.clientX,!1}function r(){u.removeClass(n.__closeButton,A.CLASS_DRAG),u.unbind(window,"mousemove",t),u.unbind(window,"mouseup",r)}function o(i){return i.preventDefault(),e=i.clientX,u.addClass(n.__closeButton,A.CLASS_DRAG),u.bind(window,"mousemove",t),u.bind(window,"mouseup",r),!1}u.bind(n.__resize_handle,"mousedown",o),u.bind(n.__closeButton,"mousedown",o),n.domElement.insertBefore(n.__resize_handle,n.domElement.firstElementChild)}function mn(n,e){n.domElement.style.width=e+"px",n.__save_row&&n.autoPlace&&(n.__save_row.style.width=e+"px"),n.__closeButton&&(n.__closeButton.style.width=e+"px")}function Qe(n,e){var t={};return m.each(n.__rememberedObjects,function(r,o){var i={},a=n.__rememberedObjectIndecesToControllers[o];m.each(a,function(s,c){i[c]=e?s.initialValue:s.getValue()}),t[o]=i}),t}function Gr(n){for(var e=0;e<n.__preset_select.length;e++)n.__preset_select[e].value===n.preset&&(n.__preset_select.selectedIndex=e)}function it(n){n.length!==0&&Mr.call(window,function(){it(n)}),m.each(n,function(e){e.updateDisplay()})}var at=A;function ct(n){let e=new at,t={openGithub:()=>{window.location.href=C.githubRepoLink},profile:()=>{n.profileNextFrame(!0)}};e.add(t,"openGithub").name("GITHUB"),i(C,"clearColor","Bg color");let r=st(C,"sortMethod",[{label:"GPU",value:"GPU"},{label:"CPU Counting sort",value:"CPU"},{label:"CPU .sort",value:"CPU_NAIVE"}]);e.add(r,"sortMethod",r.values).name("Sorting");let o=st(C,"renderMethod",[{label:"Eigenvectors",value:"EIGENVECTORS"},{label:"Square billboard",value:"SQUARE_BILLBOARD"}]);e.add(o,"renderMethod",o.values).name("Render"),e.add(C,"scaleModifier",0,2).name("Splat scale"),e.add(C,"drawGround").name("Draw ground"),e.add(t,"profile").name("Profile");function i(a,s,c){let f={value:[]};Object.defineProperty(f,"value",{enumerable:!0,get:()=>{let h=a[s];return[h[0]*255,h[1]*255,h[2]*255]},set:h=>{let l=a[s];l[0]=h[0]/255,l[1]=h[1]/255,l[2]=h[2]/255}}),e.addColor(f,"value").name(c)}}var st=(n,e,t)=>{let r={values:t.map(o=>o.label)};return Object.defineProperty(r,e,{enumerable:!0,get:()=>{let o=n[e];return(t.find(a=>a.value===o)||t[0]).label},set:o=>{let i=t.find(a=>a.label===o)||t[0];n[e]=i.value}}),r};function ut(n){console.log("Profiler:",n);let e=document.getElementById("profiler-results");e.innerHTML="",e.parentNode.style.display="block";let t={},r=new Set;n.forEach(([o,i])=>{let a=t[o]||0;t[o]=a+i,r.add(o)}),r.forEach(o=>{let i=t[o],a=document.createElement("li");a.innerHTML=`${o}: ${i.toFixed(2)}ms`,e.appendChild(a)})}var Dr=1e-6,$r=1024,xe=2,kr=$r*xe,en=class{_profileThisFrame=!1;hasRequiredFeature;queryPool;queryInProgressBuffer;resultsBuffer;currentFrameScopes=[];get enabled(){return this._profileThisFrame&&this.hasRequiredFeature}constructor(e){if(this.hasRequiredFeature=e.features.has("timestamp-query"),!this.hasRequiredFeature){this.queryPool=void 0,this.queryInProgressBuffer=void 0,this.resultsBuffer=void 0;return}this.queryPool=e.createQuerySet({type:"timestamp",count:kr}),this.queryInProgressBuffer=e.createBuffer({label:"profiler-in-progress",size:this.queryPool.count*Mn,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultsBuffer=e.createBuffer({label:"profiler-results",size:this.queryInProgressBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}profileNextFrame(e){this._profileThisFrame=e}beginFrame(){for(;this.currentFrameScopes.length>0;)this.currentFrameScopes.pop()}endFrame(e){if(!this.enabled)return;let t=this.currentFrameScopes.length*xe;e.resolveQuerySet(this.queryPool,0,t,this.queryInProgressBuffer,0),this.resultsBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.queryInProgressBuffer,0,this.resultsBuffer,0,this.resultsBuffer.size)}async scheduleRaportIfNeededAsync(e){if(!this.enabled||this.currentFrameScopes.length==0){this._profileThisFrame=!1;return}this._profileThisFrame=!1;let t=this.currentFrameScopes.slice();if(this.resultsBuffer.mapState==="unmapped"){await this.resultsBuffer.mapAsync(GPUMapMode.READ);let r=new BigInt64Array(this.resultsBuffer.getMappedRange()),o=t.map(([i,a,s],c)=>{let f=0;if(a==="gpu"){let h=r[c*xe],l=r[c*xe+1];f=Number(l-h)*Dr}else f=s;return[i,f]});this.resultsBuffer.unmap(),e?.(o)}}createScopeGpu(e){if(!this.enabled)return;let t=this.currentFrameScopes.length;return this.currentFrameScopes.push([e,"gpu",0]),{querySet:this.queryPool,beginningOfPassWriteIndex:t*xe,endOfPassWriteIndex:t*xe+1}}startRegionCpu(e){if(!this.enabled)return;let t=this.currentFrameScopes.length,r=performance.now();return this.currentFrameScopes.push([e,"cpu",r]),t}endRegionCpu(e){if(!this.enabled||e===void 0)return;let t=this.currentFrameScopes[e];if(t){let[r,o,i]=t,a=performance.now();t[2]=a-i}}};function lt(n){let e=a();n.width=e.width,n.height=e.height,console.log("Init canvas size:",e);let t=[];return{revalidateCanvasSize:o,addListener:r,getViewportSize:a};function r(s){t.push(s)}function o(){let s=a();(s.width!==n.width||s.height!==n.height)&&s.width&&s.height&&i(s)}function i(s){console.log("Canvas resize:",s),n.width=s.width,n.height=s.height,t.forEach(c=>c(s))}function a(){let s=window.devicePixelRatio||1;return{width:n.clientWidth*s,height:n.clientHeight*s}}}var ft=`struct Uniforms {
    mvpMatrix: mat4x4<f32>,
    viewMatrix: mat4x4<f32>,
    projMatrix: mat4x4<f32>,
    viewportAndFocals: vec4f,
    scaleModifier: f32,
};
@binding(0) @group(0)
var<uniform> _uniforms: Uniforms;

@group(0) @binding(1)
var<storage, read> _splatPositions: array<vec4f>;
@group(0) @binding(2)
var<storage, read> _splatRotations: array<vec4f>;
@group(0) @binding(3)
var<storage, read> _splatScales: array<vec4f>;
@group(0) @binding(4)
var<storage, read> _splatColors: array<u32>;


fn checkIsCulled(projectedPosition: vec4f) -> bool {
  let x = projectedPosition.x;
  let y = projectedPosition.y;
  let z = projectedPosition.z;
  let clipZ = projectedPosition.w;
  let clip = 1.2 * projectedPosition.w;
  return z < -clipZ || z > clipZ ||
    x < -clip || x > clip ||
    y < -clip || y > clip;
}

/**
 * https://www.sctheblog.com/blog/gaussian-splatting/#covariance-3d
 */
fn sigmaFromScaleAndRotation(scale: vec3<f32>, rot: vec4<f32>) -> mat3x3<f32> {
    let sMod = _uniforms.scaleModifier;
    let S = mat3x3<f32>(
        sMod*scale.x, 0.0, 0.0,
        0.0, sMod*scale.y, 0.0,
        0.0, 0.0, sMod*scale.z,
    );

    // quaternion to rotation matrix
    // Eq. 10, the usual stuff
    // https://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation
    let r = rot.x;
    let x = rot.y; // i
    let y = rot.z; // j
    let z = rot.w; // k
    var R = mat3x3<f32>(
        1. - 2. * (y * y + z * z), 2. * (x * y - r * z), 2. * (x * z + r * y),
        2. * (x * y + r * z), 1. - 2. * (x * x + z * z), 2. * (y * z - r * x),
        2. * (x * z - r * y), 2. * (y * z + r * x), 1. - 2. * (x * x + y * y),
    );
    R = transpose(R); // invert (it's rotation matrix after all). Left/right-handed conversion when compared to paper.

    // Equation 6 from "3D Gaussian Splatting for Real-Time Radiance Field Rendering"
    // "The covariance matrix \u03A3 of a 3D Gaussian is analogous to describing
    // the configuration of an ellipsoid. Given a scaling matrix S and
    // rotation matrix R, we can find the corresponding \u03A3:
    // $\\Sigma = R * S * S^T * R^T$"
    // PS. We are transposing scale matrix. O tempora, o mores!
    let Sigma = R * S * transpose(S) * transpose(R);
    return Sigma;
} 

/** 
 * https://www.sctheblog.com/blog/gaussian-splatting/#covariance-2d
 */
fn sigmaPrimCov2d(position: vec3<f32>, scale: vec3<f32>, rot: vec4<f32>) -> mat2x2<f32> {
    let sigma3x3 = sigmaFromScaleAndRotation(scale, rot);

    // t := posViewSpace
    var t = _uniforms.viewMatrix * vec4<f32>(position, 1.0);

    // Jacobian of the affine approximation of the projective transformation
    let focalX = _uniforms.viewportAndFocals[2];
    let focalY = _uniforms.viewportAndFocals[3];
    var J = mat4x4(
        focalX / t.z, 0.,           -(focalX * t.x) / (t.z * t.z), 0.,
        0.,           focalY / t.z, -(focalY * t.y) / (t.z * t.z), 0.,
        0., 0., 0., 0.,
        0., 0., 0., 0.,
    );
    // J = _uniforms.projMatrix; // For blog post photo
    J = transpose(J); // Left/right-handed conversion when compared to paper. Must match viewMatrix's

    // Equation (5)
    // $\\sigma' = J * W * \\sigma * W^T * J^T$
    // We go into the world space, apply sigma (so rotation+scale transforms),
    // and then go back
    let W = _uniforms.viewMatrix;
    let sigma4x4 = mat4x4(
        // covariance matrices are symmetric, so I don't have to care if row-col idx order is ok
        sigma3x3[0][0], sigma3x3[0][1], sigma3x3[0][2], 0.,
        sigma3x3[1][0], sigma3x3[1][1], sigma3x3[1][2], 0.,
        sigma3x3[2][0], sigma3x3[2][1], sigma3x3[2][2], 0.,
        0., 0., 0., 0.,
    );
    var sigma2d = J * W * sigma4x4 * transpose(W) * transpose(J);

    // Copied from reference impl.
    // https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/forward.cu#L108
    // "Apply low-pass filter: every Gaussian should be at least one pixel wide/high."
    // It probably also guarantees sigma2d is invertible?
    sigma2d[0][0] += 0.3;
    sigma2d[1][1] += 0.3;

    // Discard 3rd and 4th row and column.
    // From "EWA Splatting", below equation (23) - https://www.cs.umd.edu/~zwicker/publications/EWASplatting-TVCG02.pdf :
    // "The 2x2 variance matrix V^ is easily obtained from the 3D matrix V
    // by skipping the third row and column"
    // New matrix is a bit wasteful, but matches math nicer
    let sigmaPrim = mat2x2(
      sigma2d[0][0], sigma2d[0][1],
      sigma2d[1][0], sigma2d[1][1],
    );
    return sigmaPrim;
}

/**
 * https://www.sctheblog.com/blog/gaussian-splatting/#calculating-eigenvalues
 * 
 * I remember in high school they said:
 * "When in the real world you will make use of quadratic equation?"
 */
fn calcEigenvalues(a: f32, b: f32, c: f32) -> vec2f {
  let delta = sqrt(a*a - 2*a*c + 4*b*b + c*c);
  let lambda1 = 0.5 * (a+c + delta);
  let lambda2 = 0.5 * (a+c - delta);
  return vec2f(lambda1, lambda2);
}

const BILLBOARD_VERTICES = array<vec2<f32>, 6>(
    vec2<f32>(-1.0, -1.0),
    vec2<f32>(-1.0, 1.0),
    vec2<f32>(1.0, -1.0),
    vec2<f32>(1.0, 1.0),
    vec2<f32>(-1.0, 1.0),
    vec2<f32>(1.0, -1.0),
);

struct Gaussian {
  vertexInSplatIdx: u32,
  splatIdx: u32,
  worldPos: vec4f,
  scale: vec3f,
  rot: vec4f,
  color: vec4f,
  quadOffset: vec2f,
};

fn readGaussian(in_vertex_index: u32) -> Gaussian {
  var result: Gaussian;
  result.vertexInSplatIdx = in_vertex_index % 6u;
  result.splatIdx = in_vertex_index / 6u;
  result.worldPos = _splatPositions[result.splatIdx];
  result.scale = _splatScales[result.splatIdx].xyz;
  result.rot = _splatRotations[result.splatIdx];
  let splatColor = _splatColors[result.splatIdx];
  result.color = vec4<f32>(
    f32((splatColor >> 24) & 0xff) / 255.0,
    f32((splatColor >> 16) & 0xff) / 255.0,
    f32((splatColor >> 8 ) & 0xff) / 255.0,
    f32((splatColor      ) & 0xff) / 255.0,
  );
  result.quadOffset = BILLBOARD_VERTICES[result.vertexInSplatIdx];
  return result;
}


///////////////////////////
/// Eigenvectors version
/// https://www.sctheblog.com/blog/gaussian-splatting/#method-2-calculate-eigenvectors

struct VertexOutputEigenvectors {
  @builtin(position) position: vec4<f32>,
  @location(0) splatColor: vec4<f32>,
  @location(1) quadOffset: vec2<f32>,
};

@vertex
fn vs_mainEigenvectors(
  @builtin(vertex_index) in_vertex_index: u32,
) -> VertexOutputEigenvectors {
  var result: VertexOutputEigenvectors;
  let g = readGaussian(in_vertex_index);
  let viewportWidth = _uniforms.viewportAndFocals[0];
  let viewportHeight =_uniforms.viewportAndFocals[1];
  let viewport = vec2(viewportWidth, viewportHeight);

  // projection
  var projectedPosition = _uniforms.mvpMatrix * g.worldPos;
  if (checkIsCulled(projectedPosition)) {
    result.splatColor.w = 0.0;
    return result;
  }
  projectedPosition /= projectedPosition.w;

  // cov2d = [a  b]  <-- ASCII 2D matrix
  //         [b  c]
  let cov2d = sigmaPrimCov2d(g.worldPos.xyz, g.scale.xyz, g.rot);
  let a = cov2d[0][0];
  let b = cov2d[0][1];
  let c = cov2d[1][1];

  let eigenvalues = calcEigenvalues(a, b, c);
  let lambda1 = eigenvalues.x;
  let lambda2 = eigenvalues.y;
  
  // Use eigenvectors to calc major/minor axis
  // https://www.sctheblog.com/blog/gaussian-splatting/#vertex-shader-eigenvectors
  let diagonalVector = normalize(vec2(1, (-a+b+lambda1) / (b-c+lambda1) ));
  let diagonalVectorOther = vec2(diagonalVector.y, -diagonalVector.x);
  let majorAxis = min(3 * sqrt(lambda1), 1024) * diagonalVector;
  let minorAxis = min(3 * sqrt(lambda2), 1024) * diagonalVectorOther;
  var projectedPosition2D = projectedPosition.xy; // WGSL..
  projectedPosition2D += g.quadOffset.x * majorAxis / viewport 
                       + g.quadOffset.y * minorAxis / viewport;
  result.position = vec4<f32>(projectedPosition2D, 0.0, 1.0);
  result.quadOffset = g.quadOffset;

  // finish
  result.splatColor = g.color;
  return result;
}

@fragment
fn fs_mainEigenvectors(fragIn: VertexOutputEigenvectors) -> @location(0) vec4<f32> {
  // "3D Gaussian Splatting for Real-Time Radiance Field Rendering"
  // $\\alpha_i$ in eq.3 in 
  // $\\alpha_j$ is done through blending mode during rendering
  let opacity = fragIn.splatColor.w;

  // https://www.sctheblog.com/blog/gaussian-splatting/#fragment-shader
  // this is for circle, but our vertices projected it into an ellipsis
  let r = dot(fragIn.quadOffset, fragIn.quadOffset);
  if (r > 1.0){ discard; }
  // "The exponential function in (9) can now be written as $e^{\u22120.5*r}$",
  // where (9) is a definition for:
  // "We define an elliptical Gaussian Gv(x \u2212 p) centered at a point p with a variance matrix V as:"
  let Gv = exp(-0.5 * r);
  let a = Gv * opacity;
  return vec4(a * fragIn.splatColor.rgb, a);
}



///////////////////////////
/// Square billboard version
/// https://www.sctheblog.com/blog/gaussian-splatting/#method-1-project-gaussian-to-a-square

struct VertexOutputSquare {
  @builtin(position) position: vec4<f32>,
  @location(0) splatColor: vec4<f32>,
  @location(1) uv: vec2<f32>,
  @location(2) conic: vec4<f32>,
};

@vertex
fn vs_mainSquare(
  @builtin(vertex_index) in_vertex_index: u32,
) -> VertexOutputSquare {
  var result: VertexOutputSquare;
  let g = readGaussian(in_vertex_index);
  let viewportWidth = _uniforms.viewportAndFocals[0];
  let viewportHeight =_uniforms.viewportAndFocals[1];

  // projection
  var projectedPosition = _uniforms.mvpMatrix * g.worldPos;
  if (checkIsCulled(projectedPosition)) {
    result.splatColor.w = 0.0;
    return result;
  }
  projectedPosition /= projectedPosition.w;

  // cov2d = [a  b]  <-- ASCII 2D matrix
  //         [b  c]
  let cov2d = sigmaPrimCov2d(g.worldPos.xyz, g.scale.xyz, g.rot);
  let a = cov2d[0][0];
  let b = cov2d[0][1];
  let c = cov2d[1][1];

  let eigenvalues = calcEigenvalues(a, b, c);
  let lambda1 = eigenvalues.x;
  let lambda2 = eigenvalues.y;

  // Rendering as square (based on tiled) (draft)
  // This is slighly adopted as I'm not using the tiles
  // Uses max(\u03BB1, \u03BB2) as a radius to 'spread' the billboard vertices.
  // https://www.sctheblog.com/blog/gaussian-splatting/#calculate-tiles
  let radiusPx = ceil(3. * sqrt(max(lambda1, lambda2)));
  let radiusNdc = vec2<f32>(
    // This magic 2.0 is the reason why this mode is experimental (although it works).
    // Not sure which value is incorrect, the math seems ok. Maybe focal?
    2.0 * radiusPx / viewportWidth,
    2.0 * radiusPx / viewportHeight
  );
  result.position = vec4<f32>(projectedPosition.xy + radiusNdc * g.quadOffset, projectedPosition.zw);
  result.uv = radiusPx * g.quadOffset; // in pixels!

  // conic (inverse of cov2d)
  let det = a * c - b * b; // https://www.w3.org/TR/WGSL/#determinant-builtin
  let conic = vec3<f32>(c / det, -b / det, a / det);
  result.conic = vec4<f32>(conic, 0.0);

  // finish
  result.splatColor = g.color;
  return result;
}

@fragment
fn fs_mainSquare(fragIn: VertexOutputSquare) -> @location(0) vec4<f32> {
  let opacity = fragIn.splatColor.w;

  // Rendering as square (based on tiled) (draft)
  // https://www.sctheblog.com/blog/gaussian-splatting/#calculate-tiles
  let d = -fragIn.uv; // quadOffset in pixels
  let conic = fragIn.conic.xyz; // [0][0], [0][1] and [1][0], [1],[1]
  let power = -0.5 * (
    conic.x * d.x * d.x +
    conic.z * d.y * d.y
    ) - conic.y * d.x * d.y;

  if (power > 0.0) { discard; }

  // Eq. (2) from 3D Gaussian splatting paper.
  // Obtain alpha by multiplying with Gaussian opacity
  // and its exponential falloff from mean.
  let alpha = min(0.99, opacity * exp(power));
  return vec4<f32>(fragIn.splatColor.xyz * alpha, alpha);
}
`;var pt=`struct Uniforms {
    j: u32,
    k: u32,
};

@group(0) @binding(0)
var<storage, read_write> _indicesBuffer: array<u32>;

@group(0) @binding(1)
var<storage, read_write> _distancesBuffer: array<f32>;

@group(0) @binding(2)
var<uniform> uniforms: Uniforms;


// https://en.wikipedia.org/wiki/Bitonic_sorter
@compute
@workgroup_size(__WORKGROUP_SIZE__) // TODO?
fn main(
  @builtin(global_invocation_id) global_id: vec3<u32>, // [0,1,2,3, ..., WORKGROUP.xyz]
) {
    let itemsPerThread = u32(__ITEMS_PER_THREAD__);
    let startIdx = global_id.x * itemsPerThread;
    let endIdx = (global_id.x + 1) * itemsPerThread;
    let j = uniforms.j;
    let k = uniforms.k;

    // Single dispatch impossible, lack of global barriers in WGSL
    // https://stackoverflow.com/questions/72035548/what-does-storagebarrier-in-webgpu-actually-do
    // let elementCount = 524288u;
    // for (var k = 2u; k <= elementCount; k <<= 1u) {
    // for (var j = k >> 1u; j > 0u; j >>= 1u) {

    for (var i = startIdx; i < endIdx; i++ ) {
        let i_XOR_j = i ^ j; // WIKIPEDIA: this is 'l' on wikipedia
        if (i_XOR_j <= i) {
            continue;
        }
        let swap0 = (i & k) == 0 && _distancesBuffer[i] > _distancesBuffer[i_XOR_j];
        let swap1 = (i & k) != 0 && _distancesBuffer[i] < _distancesBuffer[i_XOR_j];
        if (swap0 || swap1) {
            // WIKIPEDIA: swap the elements arr[i] and arr[i_XOR_j]
            let tmp0 = _distancesBuffer[i];
            _distancesBuffer[i] = _distancesBuffer[i_XOR_j];
            _distancesBuffer[i_XOR_j] = tmp0;
            
            let tmp1 = _indicesBuffer[i];
            _indicesBuffer[i] = _indicesBuffer[i_XOR_j];
            _indicesBuffer[i_XOR_j] = tmp1;
        }
    }

    // workgroupBarrier(); // barriers snippet
    // storageBarrier();
    // }}
}
`;var ht=`@group(0) @binding(0)
var<storage, read> _splatPositions: array<vec4f>;

@group(0) @binding(1)
var<storage, read_write> _distancesBuffer: array<f32>;

@group(0) @binding(2)
var<storage, read_write> _indicesBuffer: array<u32>;

@group(0) @binding(3)
var<uniform> _mvpMatrix: mat4x4<f32>;

@compute
@workgroup_size(1) // TODO?
fn main(
  @builtin(global_invocation_id) global_id: vec3<u32>,
) {
    let splatCount = u32(__SPLAT_COUNT__);
    let itemsPerThread = u32(__ITEMS_PER_THREAD__);
    let startIdx = global_id.x * itemsPerThread;
    let endIdx = (global_id.x + 1u) * itemsPerThread;

    for (var i = startIdx; i < endIdx; i++ ) {
         if (i >= splatCount) {
            _distancesBuffer[i] = 999999.9f;
        } else {
            let pos = _splatPositions[i];
            let projPos = _mvpMatrix * pos;
            _distancesBuffer[i] = projPos.z;
            _indicesBuffer[i] = i;
        }
    }
}

`;var mt=`@group(0) @binding(0)
var<storage, read> _indicesBuffer: array<u32>;

@group(0) @binding(1)
var<storage, read_write> _unrolledIndices: array<u32>;

@compute
@workgroup_size(1) // TODO?
fn main(
  @builtin(global_invocation_id) global_id: vec3<u32>,
) {
    let itemsPerThread = u32(__ITEMS_PER_THREAD__);
    let startIdx = global_id.x * itemsPerThread;
    let endIdx = (global_id.x + 1u) * itemsPerThread;
    let verticesPerSplat = u32(__VERTICES_PER_SPLAT__);

    for (var i = startIdx; i < endIdx; i++) {
        let idx = _indicesBuffer[i];
        for (var j = 0u; j < verticesPerSplat; j++) {
            _unrolledIndices[i * verticesPerSplat + j] = idx * verticesPerSplat + j;
        }
    }
}`;var qr="nike.splat";(async function(){let n=await Bn();if(!n){vn();return}let e=In(n);e.startErrorScope("init");let t=navigator.gpu.getPreferredCanvasFormat(),[r,o]=Hr("#gpuCanvas",n,t),i=lt(r),a=Dn(window,r),s=await jr(n,qr),c=new en(n);$n({splatPassShader:ft,sortBitonicShader:pt,sortCalcDeptsShader:ht,sortUnrollIndicesShader:mt});let f=new Xe(n,i.getViewportSize(),t,s);i.addListener(f.onCanvasResize),ct(c);let[h,l]=Ln(),p=Date.now(),d=!1,v=await e.reportErrorScopeAsync();if(v){vn(v);return}let g=()=>{e.startErrorScope("frame"),l(),h(),c.beginFrame();let _=Date.now(),y=(_-p)/1e3;p=_,i.revalidateCanvasSize();let b=a();f.updateCamera(y,b);let w=n.createCommandEncoder({label:"main-frame-cmd-buffer"});f.cmdRender({cmdBuf:w,device:n,profiler:c,splats:s,viewport:i.getViewportSize()},o.getCurrentTexture()),c.endFrame(w),n.queue.submit([w.finish()]),c.scheduleRaportIfNeededAsync(ut),d||(e.reportErrorScopeAsync(S=>{throw vn(S),d=!0,new Error(S)}),requestAnimationFrame(g))};requestAnimationFrame(g)})();function Hr(n,e,t){let r=document.querySelector(n),o=r.getContext("webgpu");return o.configure({device:e,format:t,alphaMode:"premultiplied"}),[r,o]}async function Vr(n){let e=await fetch(n);if(!e.ok)throw`Could not download tfx file '${n}'`;return await e.arrayBuffer()}async function jr(n,e){let t=await Vr(e),r=new Uint8Array(t),o=zn(n,r);return console.log("Parsed file",o.count,"splats"),o}function vn(n){document.getElementById("gpuCanvas").style.display="none",document.getElementById("no-webgpu").style.display="flex",n&&(document.getElementById("error-msg").textContent=n)}})();
//# sourceMappingURL=index.web.js.map
